<html><head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="siteify.css">
<script>

var lastlink;

function expand(a) {
    if ( a.children[0].style.display != "block" ) {
        if ( lastlink )
            lastlink.style.display = "none";
        a.children[0].style.display = "block";
        lastlink = a.children[0];
    }
    else {
        a.children[0].style.display = "none";
        lastlink = null;
    }
    return false;
}

</script></head><body><pre>
0001    <span class='comment'><a name='1_0' title='usrString0'>//
0002    </a></span><span class='comment'><a name='2_0' title='usrString0'>//  MessageTransport.swift
0003    </a></span><span class='comment'><a name='3_0' title='usrString0'>//  SwiftLSPClient
0004    </a></span><span class='comment'><a name='4_0' title='usrString0'>//
0005    </a></span><span class='comment'><a name='5_0' title='usrString0'>//  Created by Matt Massicotte on 2018-10-15.
0006    </a></span><span class='comment'><a name='6_0' title='usrString0'>//  Copyright Â© 2018 Chime Systems. All rights reserved.
0007    </a></span><span class='comment'><a name='7_0' title='usrString0'>//
0008    </a></span>
0009    <span class='keyword'><a name='9_0' title='usrString0'>import</a></span> <span class='identifier'><a name='9_7'>Foundation</a></span>
0010    
0011    <span class='builtin'><a name='11_0' title='usrString0'>public</a></span> <span class='keyword'><a name='11_7' title='usrString0'>class</a></span> <span class='identifier'><a name='11_13'>MessageTransport</a></span> {
0012        <span class='builtin'><a name='12_4' title='usrString0'>private</a></span> <span class='keyword'><a name='12_12' title='usrString0'>let</a></span> <span class='identifier'><a name='12_16'>dataTransport</a></span>: <span class='typeidentifier'><a name='12_31' title='usrString0'>DataTransport</a></span>
0013        <span class='keyword'><a name='13_4' title='usrString0'>var</a></span> <span class='identifier'><a name='13_8'>dataHandler</a></span>: <span class='typeidentifier'><a name='13_21' title='usrString0'>DataTransport</a></span>.<span class='typeidentifier'><a name='13_35' title='usrString0'>ReadHandler</a></span>?
0014        <span class='builtin'><a name='14_4' title='usrString0'>private</a></span> <span class='keyword'><a name='14_12' title='usrString0'>var</a></span> <span class='identifier'><a name='14_16'>buffer</a></span>: <span class='typeidentifier'><a name='14_24' title='usrString0'>Data</a></span>
0015        
0016        <span class='builtin'><a name='16_4' title='usrString0'>private</a></span> <span class='keyword'><a name='16_12' title='usrString0'>static</a></span> <span class='keyword'><a name='16_19' title='usrString0'>var</a></span> <span class='identifier'><a name='16_23'>partSeperator</a></span> = <span class='string'><a name='16_39' title='usrString0'>"\r\n"</a></span>.<span class='identifier'><a name='16_46'>data</a></span>(<span class='identifier'><a name='16_51'>using</a></span>: .<span class='identifier'><a name='16_59'>utf8</a></span>)!
0017        <span class='builtin'><a name='17_4' title='usrString0'>private</a></span> <span class='keyword'><a name='17_12' title='usrString0'>static</a></span> <span class='keyword'><a name='17_19' title='usrString0'>var</a></span> <span class='identifier'><a name='17_23'>headerSeperator</a></span> = <span class='string'><a name='17_41' title='usrString0'>": "</a></span>.<span class='identifier'><a name='17_46'>data</a></span>(<span class='identifier'><a name='17_51'>using</a></span>: .<span class='identifier'><a name='17_59'>utf8</a></span>)!
0018    
0019        <span class='builtin'><a name='19_4' title='usrString0'>public</a></span> <span class='keyword'><a name='19_11' title='usrString0'>init</a></span>(<span class='identifier'><a name='19_16'>dataTransport</a></span>: <span class='typeidentifier'><a name='19_31' title='usrString0'>DataTransport</a></span>) {
0020            <span class='keyword'><a name='20_8' title='usrString0'>self</a></span>.<span class='identifier'><a name='20_13'>dataTransport</a></span> = <span class='identifier'><a name='20_29'>dataTransport</a></span>
0021            <span class='keyword'><a name='21_8' title='usrString0'>self</a></span>.<span class='identifier'><a name='21_13'>buffer</a></span> = <span class='identifier'><a name='21_22'>Data</a></span>()
0022            
0023            <span class='keyword'><a name='23_8' title='usrString0'>self</a></span>.<span class='identifier'><a name='23_13'>dataTransport</a></span>.<span class='identifier'><a name='23_27'>setReaderHandler</a></span>({ [<span class='builtin'><a name='23_47' title='usrString0'>unowned</a></span> <span class='keyword'><a name='23_55' title='usrString0'>self</a></span>] (<span class='identifier'><a name='23_62'>data</a></span>) <span class='keyword'><a name='23_68' title='usrString0'>in</a></span>
0024                <span class='keyword'><a name='24_12' title='usrString0'>guard</a></span> <span class='identifier'><a name='24_18'>data</a></span>.<span class='identifier'><a name='24_23'>count</a></span> > <span class='number'><a name='24_31' title='usrString0'>0</a></span> <span class='keyword'><a name='24_33' title='usrString0'>else</a></span> {
0025                    <span class='keyword'><a name='25_16' title='usrString0'>return</a></span>
0026                }
0027                
0028                <span class='keyword'><a name='28_12' title='usrString0'>self</a></span>.<span class='identifier'><a name='28_17'>dataReceived</a></span>(<span class='identifier'><a name='28_30'>data</a></span>)
0029            })
0030        }
0031    
0032        <span class='builtin'><a name='32_4' title='usrString0'>private</a></span> <span class='keyword'><a name='32_12' title='usrString0'>func</a></span> <span class='identifier'><a name='32_17'>dataReceived</a></span>(<span class='keyword'><a name='32_30' title='usrString0'>_</a></span> <span class='identifier'><a name='32_32'>data</a></span>: <span class='typeidentifier'><a name='32_38' title='usrString0'>Data</a></span>) {
0033            <span class='identifier'><a name='33_8'>buffer</a></span>.<span class='identifier'><a name='33_15'>append</a></span>(<span class='identifier'><a name='33_22'>data</a></span>)
0034            
0035            <span class='identifier'><a name='35_8'>checkBuffer</a></span>()
0036        }
0037    
0038        <span class='builtin'><a name='38_4' title='usrString0'>private</a></span> <span class='keyword'><a name='38_12' title='usrString0'>func</a></span> <span class='identifier'><a name='38_17'>checkBuffer</a></span>() {
0039            <span class='keyword'><a name='39_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='39_14' title='usrString0'>let</a></span> <span class='identifier'><a name='39_18'>contentRange</a></span> = <span class='identifier'><a name='39_33'>readContentRange</a></span>(<span class='identifier'><a name='39_50'>in</a></span>: <span class='identifier'><a name='39_54'>buffer</a></span>) <span class='keyword'><a name='39_62' title='usrString0'>else</a></span> {
0040                <span class='keyword'><a name='40_12' title='usrString0'>return</a></span>
0041            }
0042    
0043            <span class='keyword'><a name='43_8' title='usrString0'>if</a></span> <span class='identifier'><a name='43_11'>buffer</a></span>.<span class='identifier'><a name='43_18'>endIndex</a></span> &lt; <span class='identifier'><a name='43_29'>contentRange</a></span>.<span class='identifier'><a name='43_42'>upperBound</a></span> {
0044                <span class='keyword'><a name='44_12' title='usrString0'>return</a></span>
0045            }
0046    
0047            <span class='keyword'><a name='47_8' title='usrString0'>let</a></span> <span class='identifier'><a name='47_12'>content</a></span> = <span class='identifier'><a name='47_22'>buffer</a></span>.<span class='identifier'><a name='47_29'>subdata</a></span>(<span class='identifier'><a name='47_37'>in</a></span>: <span class='identifier'><a name='47_41'>contentRange</a></span>)
0048            <span class='keyword'><a name='48_8' title='usrString0'>let</a></span> <span class='identifier'><a name='48_12'>messageRange</a></span> = <span class='identifier'><a name='48_27'>buffer</a></span>.<span class='identifier'><a name='48_34'>startIndex</a></span>..&lt;<span class='identifier'><a name='48_47'>contentRange</a></span>.<span class='identifier'><a name='48_60'>upperBound</a></span>
0049    
0050            <span class='identifier'><a name='50_8'>precondition</a></span>(<span class='identifier'><a name='50_21'>messageRange</a></span>.<span class='identifier'><a name='50_34'>count</a></span> > <span class='number'><a name='50_42' title='usrString0'>0</a></span>)
0051            
0052            <span class='identifier'><a name='52_8'>buffer</a></span>.<span class='identifier'><a name='52_15'>removeSubrange</a></span>(<span class='identifier'><a name='52_30'>messageRange</a></span>)
0053    
0054            <span class='keyword'><a name='54_8' title='usrString0'>self</a></span>.<span class='identifier'><a name='54_13'>dataHandler</a></span>?(<span class='identifier'><a name='54_26'>content</a></span>)
0055    
0056            <span class='comment'><a name='56_8' title='usrString0'>// call recursively *only* if we have removed some data
0057    </a></span>        <span class='keyword'><a name='57_8' title='usrString0'>if</a></span> !<span class='identifier'><a name='57_12'>buffer</a></span>.<span class='identifier'><a name='57_19'>isEmpty</a></span> {
0058                <span class='identifier'><a name='58_12'>checkBuffer</a></span>()
0059            }
0060        }
0061    
0062        <span class='builtin'><a name='62_4' title='usrString0'>private</a></span> <span class='keyword'><a name='62_12' title='usrString0'>func</a></span> <span class='identifier'><a name='62_17'>readContentRange</a></span>(<span class='identifier'><a name='62_34'>in</a></span> <span class='identifier'><a name='62_37'>data</a></span>: <span class='typeidentifier'><a name='62_43' title='usrString0'>Data</a></span>) -> <span class='typeidentifier'><a name='62_52' title='usrString0'>Range</a></span>&lt;<span class='typeidentifier'><a name='62_58' title='usrString0'>Data</a></span>.<span class='typeidentifier'><a name='62_63' title='usrString0'>Index</a></span>>? {
0063            <span class='keyword'><a name='63_8' title='usrString0'>let</a></span> <span class='identifier'><a name='63_12'>seperator</a></span> = <span class='string'><a name='63_24' title='usrString0'>"\r\n\r\n"</a></span>.<span class='identifier'><a name='63_35'>data</a></span>(<span class='identifier'><a name='63_40'>using</a></span>: .<span class='identifier'><a name='63_48'>utf8</a></span>)!
0064            
0065            <span class='keyword'><a name='65_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='65_14' title='usrString0'>let</a></span> <span class='identifier'><a name='65_18'>range</a></span> = <span class='identifier'><a name='65_26'>data</a></span>.<span class='identifier'><a name='65_31'>range</a></span>(<span class='identifier'><a name='65_37'>of</a></span>: <span class='identifier'><a name='65_41'>seperator</a></span>) <span class='keyword'><a name='65_52' title='usrString0'>else</a></span> {
0066                <span class='keyword'><a name='66_12' title='usrString0'>return</a></span> <span class='keyword'><a name='66_19' title='usrString0'>nil</a></span>
0067            }
0068            
0069            <span class='keyword'><a name='69_8' title='usrString0'>let</a></span> <span class='identifier'><a name='69_12'>headersSectionRange</a></span> = <span class='identifier'><a name='69_34'>data</a></span>.<span class='identifier'><a name='69_39'>startIndex</a></span>..&lt;<span class='identifier'><a name='69_52'>range</a></span>.<span class='identifier'><a name='69_58'>lowerBound</a></span>
0070            
0071            <span class='keyword'><a name='71_8' title='usrString0'>let</a></span> <span class='identifier'><a name='71_12'>headers</a></span> = <span class='identifier'><a name='71_22'>readHeaders</a></span>(<span class='identifier'><a name='71_34'>from</a></span>: <span class='identifier'><a name='71_40'>data</a></span>, <span class='identifier'><a name='71_46'>in</a></span>: <span class='identifier'><a name='71_50'>headersSectionRange</a></span>)
0072            
0073            <span class='keyword'><a name='73_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='73_14' title='usrString0'>let</a></span> <span class='identifier'><a name='73_18'>lengthValue</a></span> = <span class='identifier'><a name='73_32'>headers</a></span>[<span class='string'><a name='73_40' title='usrString0'>"Content-Length"</a></span>] <span class='keyword'><a name='73_58' title='usrString0'>else</a></span> {
0074                <span class='keyword'><a name='74_12' title='usrString0'>return</a></span> <span class='keyword'><a name='74_19' title='usrString0'>nil</a></span>
0075            }
0076            
0077            <span class='keyword'><a name='77_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='77_14' title='usrString0'>let</a></span> <span class='identifier'><a name='77_18'>length</a></span> = <span class='identifier'><a name='77_27'>Int</a></span>(<span class='identifier'><a name='77_31'>lengthValue</a></span>) <span class='keyword'><a name='77_44' title='usrString0'>else</a></span> {
0078                <span class='keyword'><a name='78_12' title='usrString0'>return</a></span> <span class='keyword'><a name='78_19' title='usrString0'>nil</a></span>
0079            }
0080            
0081            <span class='keyword'><a name='81_8' title='usrString0'>let</a></span> <span class='identifier'><a name='81_12'>upperLimit</a></span> = <span class='identifier'><a name='81_25'>length</a></span> + <span class='identifier'><a name='81_34'>range</a></span>.<span class='identifier'><a name='81_40'>upperBound</a></span>
0082            
0083            <span class='keyword'><a name='83_8' title='usrString0'>return</a></span> <span class='identifier'><a name='83_15'>range</a></span>.<span class='identifier'><a name='83_21'>upperBound</a></span>..&lt;<span class='identifier'><a name='83_34'>upperLimit</a></span>
0084        }
0085        
0086        <span class='builtin'><a name='86_4' title='usrString0'>private</a></span> <span class='keyword'><a name='86_12' title='usrString0'>func</a></span> <span class='identifier'><a name='86_17'>readHeaders</a></span>(<span class='identifier'><a name='86_29'>from</a></span> <span class='identifier'><a name='86_34'>data</a></span>: <span class='typeidentifier'><a name='86_40' title='usrString0'>Data</a></span>, <span class='identifier'><a name='86_46'>in</a></span> <span class='identifier'><a name='86_49'>range</a></span>: <span class='typeidentifier'><a name='86_56' title='usrString0'>Range</a></span>&lt;<span class='typeidentifier'><a name='86_62' title='usrString0'>Data</a></span>.<span class='typeidentifier'><a name='86_67' title='usrString0'>Index</a></span>>) -> [<span class='typeidentifier'><a name='86_79' title='usrString0'>String</a></span>: <span class='typeidentifier'><a name='86_87' title='usrString0'>String</a></span>] {
0087            <span class='keyword'><a name='87_8' title='usrString0'>var</a></span> <span class='identifier'><a name='87_12'>headers</a></span>: [<span class='typeidentifier'><a name='87_22' title='usrString0'>String</a></span>: <span class='typeidentifier'><a name='87_30' title='usrString0'>String</a></span>] = [:]
0088    
0089            <span class='keyword'><a name='89_8' title='usrString0'>var</a></span> <span class='identifier'><a name='89_12'>location</a></span> = <span class='identifier'><a name='89_23'>range</a></span>.<span class='identifier'><a name='89_29'>lowerBound</a></span>
0090            
0091            <span class='keyword'><a name='91_8' title='usrString0'>while</a></span> <span class='identifier'><a name='91_14'>location</a></span> &lt; <span class='identifier'><a name='91_25'>range</a></span>.<span class='identifier'><a name='91_31'>upperBound</a></span> {
0092                <span class='keyword'><a name='92_12' title='usrString0'>let</a></span> <span class='identifier'><a name='92_16'>searchRange</a></span> = <span class='identifier'><a name='92_30'>location</a></span>..&lt;<span class='identifier'><a name='92_41'>range</a></span>.<span class='identifier'><a name='92_47'>upperBound</a></span>
0093                
0094                <span class='keyword'><a name='94_12' title='usrString0'>guard</a></span> <span class='keyword'><a name='94_18' title='usrString0'>let</a></span> <span class='identifier'><a name='94_22'>headerData</a></span> = <span class='identifier'><a name='94_35'>readHeader</a></span>(<span class='identifier'><a name='94_46'>in</a></span>: <span class='identifier'><a name='94_50'>data</a></span>, <span class='identifier'><a name='94_56'>range</a></span>: <span class='identifier'><a name='94_63'>searchRange</a></span>) <span class='keyword'><a name='94_76' title='usrString0'>else</a></span> {
0095                    <span class='keyword'><a name='95_16' title='usrString0'>break</a></span>
0096                }
0097                
0098                <span class='keyword'><a name='98_12' title='usrString0'>let</a></span> (<span class='identifier'><a name='98_17'>key</a></span>, <span class='identifier'><a name='98_22'>value</a></span>, <span class='identifier'><a name='98_29'>limit</a></span>) = <span class='identifier'><a name='98_38'>headerData</a></span>
0099                
0100                <span class='identifier'><a name='100_12'>headers</a></span>[<span class='identifier'><a name='100_20'>key</a></span>] = <span class='identifier'><a name='100_27'>value</a></span>
0101                
0102                <span class='identifier'><a name='102_12'>location</a></span> = <span class='identifier'><a name='102_23'>limit</a></span>
0103            }
0104            
0105            <span class='keyword'><a name='105_8' title='usrString0'>return</a></span> <span class='identifier'><a name='105_15'>headers</a></span>
0106        }
0107        
0108        <span class='keyword'><a name='108_4' title='usrString0'>func</a></span> <span class='identifier'><a name='108_9'>readHeader</a></span>(<span class='identifier'><a name='108_20'>in</a></span> <span class='identifier'><a name='108_23'>data</a></span>: <span class='typeidentifier'><a name='108_29' title='usrString0'>Data</a></span>, <span class='identifier'><a name='108_35'>range</a></span>: <span class='typeidentifier'><a name='108_42' title='usrString0'>Range</a></span>&lt;<span class='typeidentifier'><a name='108_48' title='usrString0'>Data</a></span>.<span class='typeidentifier'><a name='108_53' title='usrString0'>Index</a></span>>) -> (<span class='typeidentifier'><a name='108_65' title='usrString0'>String</a></span>, <span class='typeidentifier'><a name='108_73' title='usrString0'>String</a></span>, <span class='typeidentifier'><a name='108_81' title='usrString0'>Data</a></span>.<span class='typeidentifier'><a name='108_86' title='usrString0'>Index</a></span>)? {
0109            <span class='keyword'><a name='109_8' title='usrString0'>let</a></span> <span class='identifier'><a name='109_12'>seperator</a></span> = <span class='string'><a name='109_24' title='usrString0'>"\r\n"</a></span>.<span class='identifier'><a name='109_31'>data</a></span>(<span class='identifier'><a name='109_36'>using</a></span>: .<span class='identifier'><a name='109_44'>utf8</a></span>)!
0110            <span class='keyword'><a name='110_8' title='usrString0'>let</a></span> <span class='identifier'><a name='110_12'>headerSeperator</a></span> = <span class='string'><a name='110_30' title='usrString0'>": "</a></span>.<span class='identifier'><a name='110_35'>data</a></span>(<span class='identifier'><a name='110_40'>using</a></span>: .<span class='identifier'><a name='110_48'>utf8</a></span>)!
0111            
0112            <span class='keyword'><a name='112_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='112_14' title='usrString0'>let</a></span> <span class='identifier'><a name='112_18'>seperatorRange</a></span> = <span class='identifier'><a name='112_35'>data</a></span>.<span class='identifier'><a name='112_40'>range</a></span>(<span class='identifier'><a name='112_46'>of</a></span>: <span class='identifier'><a name='112_50'>headerSeperator</a></span>, <span class='identifier'><a name='112_67'>options</a></span>: [], <span class='identifier'><a name='112_80'>in</a></span>: <span class='identifier'><a name='112_84'>range</a></span>) <span class='keyword'><a name='112_91' title='usrString0'>else</a></span> {
0113                <span class='keyword'><a name='113_12' title='usrString0'>return</a></span> <span class='keyword'><a name='113_19' title='usrString0'>nil</a></span>
0114            }
0115            
0116            <span class='keyword'><a name='116_8' title='usrString0'>let</a></span> <span class='identifier'><a name='116_12'>keyRange</a></span> = <span class='identifier'><a name='116_23'>range</a></span>.<span class='identifier'><a name='116_29'>lowerBound</a></span>..&lt;<span class='identifier'><a name='116_42'>seperatorRange</a></span>.<span class='identifier'><a name='116_57'>lowerBound</a></span>
0117            <span class='keyword'><a name='117_8' title='usrString0'>let</a></span> <span class='identifier'><a name='117_12'>postSeperatorRange</a></span> = <span class='identifier'><a name='117_33'>seperatorRange</a></span>.<span class='identifier'><a name='117_48'>upperBound</a></span>..&lt;<span class='identifier'><a name='117_61'>range</a></span>.<span class='identifier'><a name='117_67'>upperBound</a></span>
0118            
0119            <span class='keyword'><a name='119_8' title='usrString0'>let</a></span> <span class='identifier'><a name='119_12'>terminatorRange</a></span> = <span class='identifier'><a name='119_30'>data</a></span>.<span class='identifier'><a name='119_35'>range</a></span>(<span class='identifier'><a name='119_41'>of</a></span>: <span class='identifier'><a name='119_45'>seperator</a></span>, <span class='identifier'><a name='119_56'>options</a></span>: [], <span class='identifier'><a name='119_69'>in</a></span>: <span class='identifier'><a name='119_73'>postSeperatorRange</a></span>)
0120            <span class='keyword'><a name='120_8' title='usrString0'>let</a></span> <span class='identifier'><a name='120_12'>valueUpperBound</a></span> = <span class='identifier'><a name='120_30'>terminatorRange</a></span>?.<span class='identifier'><a name='120_47'>lowerBound</a></span> ?? <span class='identifier'><a name='120_61'>range</a></span>.<span class='identifier'><a name='120_67'>upperBound</a></span>
0121            <span class='keyword'><a name='121_8' title='usrString0'>let</a></span> <span class='identifier'><a name='121_12'>valueRange</a></span> = <span class='identifier'><a name='121_25'>postSeperatorRange</a></span>.<span class='identifier'><a name='121_44'>lowerBound</a></span>..&lt;<span class='identifier'><a name='121_57'>valueUpperBound</a></span>
0122            
0123            <span class='keyword'><a name='123_8' title='usrString0'>let</a></span> <span class='identifier'><a name='123_12'>keyData</a></span> = <span class='identifier'><a name='123_22'>data</a></span>.<span class='identifier'><a name='123_27'>subdata</a></span>(<span class='identifier'><a name='123_35'>in</a></span>: <span class='identifier'><a name='123_39'>keyRange</a></span>)
0124            <span class='keyword'><a name='124_8' title='usrString0'>let</a></span> <span class='identifier'><a name='124_12'>valueData</a></span> = <span class='identifier'><a name='124_24'>data</a></span>.<span class='identifier'><a name='124_29'>subdata</a></span>(<span class='identifier'><a name='124_37'>in</a></span>: <span class='identifier'><a name='124_41'>valueRange</a></span>)
0125            
0126            <span class='keyword'><a name='126_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='126_14' title='usrString0'>let</a></span> <span class='identifier'><a name='126_18'>key</a></span> = <span class='identifier'><a name='126_24'>String</a></span>(<span class='identifier'><a name='126_31'>data</a></span>: <span class='identifier'><a name='126_37'>keyData</a></span>, <span class='identifier'><a name='126_46'>encoding</a></span>: .<span class='identifier'><a name='126_57'>utf8</a></span>) <span class='keyword'><a name='126_63' title='usrString0'>else</a></span> {
0127                <span class='keyword'><a name='127_12' title='usrString0'>return</a></span> <span class='keyword'><a name='127_19' title='usrString0'>nil</a></span>
0128            }
0129    
0130            <span class='keyword'><a name='130_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='130_14' title='usrString0'>let</a></span> <span class='identifier'><a name='130_18'>value</a></span> = <span class='identifier'><a name='130_26'>String</a></span>(<span class='identifier'><a name='130_33'>data</a></span>: <span class='identifier'><a name='130_39'>valueData</a></span>, <span class='identifier'><a name='130_50'>encoding</a></span>: .<span class='identifier'><a name='130_61'>utf8</a></span>) <span class='keyword'><a name='130_67' title='usrString0'>else</a></span> {
0131                <span class='keyword'><a name='131_12' title='usrString0'>return</a></span> <span class='keyword'><a name='131_19' title='usrString0'>nil</a></span>
0132            }
0133            
0134            <span class='keyword'><a name='134_8' title='usrString0'>let</a></span> <span class='identifier'><a name='134_12'>endOfHeader</a></span> = <span class='identifier'><a name='134_26'>terminatorRange</a></span>?.<span class='identifier'><a name='134_43'>upperBound</a></span> ?? <span class='identifier'><a name='134_57'>range</a></span>.<span class='identifier'><a name='134_63'>upperBound</a></span>
0135            
0136            <span class='keyword'><a name='136_8' title='usrString0'>return</a></span> (<span class='identifier'><a name='136_16'>key</a></span>, <span class='identifier'><a name='136_21'>value</a></span>, <span class='identifier'><a name='136_28'>endOfHeader</a></span>)
0137        }
0138    }
0139    
0140    <span class='keyword'><a name='140_0' title='usrString0'>extension</a></span> <span class='typeidentifier'><a name='140_10' title='usrString0'>MessageTransport</a></span>: <span class='typeidentifier'><a name='140_28' title='usrString0'>DataTransport</a></span> {
0141        <span class='builtin'><a name='141_4' title='usrString0'>public</a></span> <span class='keyword'><a name='141_11' title='usrString0'>func</a></span> <span class='identifier'><a name='141_16'>write</a></span>(<span class='keyword'><a name='141_22' title='usrString0'>_</a></span> <span class='identifier'><a name='141_24'>data</a></span>: <span class='typeidentifier'><a name='141_30' title='usrString0'>Data</a></span>) {
0142            <span class='keyword'><a name='142_8' title='usrString0'>let</a></span> <span class='identifier'><a name='142_12'>length</a></span> = <span class='identifier'><a name='142_21'>data</a></span>.<span class='identifier'><a name='142_26'>count</a></span>
0143    
0144            <span class='keyword'><a name='144_8' title='usrString0'>let</a></span> <span class='identifier'><a name='144_12'>header</a></span> = <span class='string'><a name='144_21' title='usrString0'>"Content-Length: </a></span>\<span class='string_interpolation_anchor'><a name='144_39' title='usrString0'>(</a></span><span class='identifier'><a name='144_40'>length</a></span><span class='string_interpolation_anchor'><a name='144_46' title='usrString0'>)</a></span><span class='string'><a name='144_47' title='usrString0'>\r\n\r\n"</a></span>
0145            <span class='keyword'><a name='145_8' title='usrString0'>guard</a></span> <span class='keyword'><a name='145_14' title='usrString0'>let</a></span> <span class='identifier'><a name='145_18'>headerData</a></span> = <span class='identifier'><a name='145_31'>header</a></span>.<span class='identifier'><a name='145_38'>data</a></span>(<span class='identifier'><a name='145_43'>using</a></span>: .<span class='identifier'><a name='145_51'>utf8</a></span>) <span class='keyword'><a name='145_57' title='usrString0'>else</a></span> {
0146                <span class='identifier'><a name='146_12'>fatalError</a></span>()
0147            }
0148    
0149            <span class='keyword'><a name='149_8' title='usrString0'>let</a></span> <span class='identifier'><a name='149_12'>messageData</a></span> = <span class='identifier'><a name='149_26'>headerData</a></span> + <span class='identifier'><a name='149_39'>data</a></span>
0150    
0151            <span class='identifier'><a name='151_8'>dataTransport</a></span>.<span class='identifier'><a name='151_22'>write</a></span>(<span class='identifier'><a name='151_28'>messageData</a></span>)
0152        }
0153    
0154        <span class='builtin'><a name='154_4' title='usrString0'>public</a></span> <span class='keyword'><a name='154_11' title='usrString0'>func</a></span> <span class='identifier'><a name='154_16'>setReaderHandler</a></span>(<span class='keyword'><a name='154_33' title='usrString0'>_</a></span> <span class='identifier'><a name='154_35'>handler</a></span>: <span class='builtin'><a name='154_44' title='usrString0'>@escaping</a></span> <span class='typeidentifier'><a name='154_54' title='usrString0'>DataTransport</a></span>.<span class='typeidentifier'><a name='154_68' title='usrString0'>ReadHandler</a></span>) {
0155            <span class='keyword'><a name='155_8' title='usrString0'>self</a></span>.<span class='identifier'><a name='155_13'>dataHandler</a></span> = <span class='identifier'><a name='155_27'>handler</a></span>
0156        }
0157    
0158        <span class='builtin'><a name='158_4' title='usrString0'>public</a></span> <span class='keyword'><a name='158_11' title='usrString0'>func</a></span> <span class='identifier'><a name='158_16'>close</a></span>() {
0159            <span class='identifier'><a name='159_8'>dataTransport</a></span>.<span class='identifier'><a name='159_22'>close</a></span>()
0160        }
0161    }
0162    