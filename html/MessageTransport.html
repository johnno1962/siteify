<html><head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="siteify.css">
<script>

var lastlink;

function expand(a) {
    if ( a.children[0].style.display != "block" ) {
        if ( lastlink )
            lastlink.style.display = "none";
        a.children[0].style.display = "block";
        lastlink = a.children[0];
    }
    else {
        a.children[0].style.display = "none";
        lastlink = null;
    }
    return false;
}

</script></head><body><h3>.build/checkouts/SwiftLSPClient/SwiftLSPClient/JSONRPC/MessageTransport.swift</h3><pre><span class=lineno>0001</span>    <span class='comment'>//
<span class=lineno>0002</span>    </span><span class='comment'>//  MessageTransport.swift
<span class=lineno>0003</span>    </span><span class='comment'>//  SwiftLSPClient
<span class=lineno>0004</span>    </span><span class='comment'>//
<span class=lineno>0005</span>    </span><span class='comment'>//  Created by Matt Massicotte on 2018-10-15.
<span class=lineno>0006</span>    </span><span class='comment'>//  Copyright Â© 2018 Chime Systems. All rights reserved.
<span class=lineno>0007</span>    </span><span class='comment'>//
<span class=lineno>0008</span>    </span>
<span class=lineno>0009</span>    <span class='keyword'>import</span> <span class='identifier'>Foundation</span>
<span class=lineno>0010</span>    
<span class=lineno>0011</span>    <span class='builtin'>public</span> <span class='keyword'>class</span> <span class='identifier'><a name='11_13' href='#' title='usrString2' onclick='return expand(this);'>MessageTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#155_10"; return false;'>MessageTransport.swift:155</td><td><pre>extension MessageTransport: DataTransport {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#157_26"; return false;'>MessageTransport.swift:157</td><td><pre>        let messageData = MessageTransport.createMessage(with: data)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#29_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:29</td><td><pre>    private let messageTransport: MessageTransport</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#36_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:36</td><td><pre>    public init(messageTransport: MessageTransport) {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#49_31"; event.stopPropagation(); return false;'>ProtocolTransport.swift:49</td><td><pre>        let messageTransport = MessageTransport(dataTransport: dataTransport)</pre></td></table></span></a></span> {
<span class=lineno>0012</span>        <span class='builtin'>private</span> <span class='keyword'>let</span> <span class='identifier'><a name='12_16' href='#' title='usrString2' onclick='return expand(this);'>dataTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#20_13"; return false;'>MessageTransport.swift:20</td><td><pre>        self.dataTransport = dataTransport</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#27_8"; return false;'>MessageTransport.swift:27</td><td><pre>        dataTransport.setReaderHandler({ [unowned self] (data) in</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#159_8"; return false;'>MessageTransport.swift:159</td><td><pre>        dataTransport.write(messageData)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#167_8"; return false;'>MessageTransport.swift:167</td><td><pre>        dataTransport.close()</pre></td></table></span></a></span>: <span class='typeidentifier'>DataTransport</span>
<span class=lineno>0013</span>        <span class='keyword'>var</span> <span class='identifier'><a name='13_8' href='#' title='usrString2' onclick='return expand(this);'>dataHandler<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#58_13"; return false;'>MessageTransport.swift:58</td><td><pre>        self.dataHandler?(content)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#163_13"; return false;'>MessageTransport.swift:163</td><td><pre>        self.dataHandler = handler</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#43_30"; event.stopPropagation(); return false;'>ProtocolTransport.swift:43</td><td><pre>        self.messageTransport.dataHandler = { [unowned self] (data) in</pre></td></table></span></a></span>: <span class='typeidentifier'>DataTransport</span>.<span class='typeidentifier'>ReadHandler</span>?
<span class=lineno>0014</span>        <span class='builtin'>private</span> <span class='keyword'>var</span> <span class='identifier'><a name='14_16' href='#' title='usrString2' onclick='return expand(this);'>buffer<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#21_13"; return false;'>MessageTransport.swift:21</td><td><pre>        self.buffer = Data()</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#37_8"; return false;'>MessageTransport.swift:37</td><td><pre>        buffer.append(data)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#43_54"; return false;'>MessageTransport.swift:43</td><td><pre>        guard let contentRange = readContentRange(in: buffer) else {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#47_11"; return false;'>MessageTransport.swift:47</td><td><pre>        if buffer.endIndex &lt; contentRange.upperBound {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#51_22"; return false;'>MessageTransport.swift:51</td><td><pre>        let content = buffer.subdata(in: contentRange)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#52_27"; return false;'>MessageTransport.swift:52</td><td><pre>        let messageRange = buffer.startIndex..&lt;contentRange.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#56_8"; return false;'>MessageTransport.swift:56</td><td><pre>        buffer.removeSubrange(messageRange)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#61_12"; return false;'>MessageTransport.swift:61</td><td><pre>        if !buffer.isEmpty {</pre></td></table></span></a></span>: <span class='typeidentifier'>Data</span>
<span class=lineno>0015</span>        
<span class=lineno>0016</span>        <span class='builtin'>private</span> <span class='keyword'>static</span> <span class='keyword'>var</span> <span class='identifier'><a name='16_23' title='usrString2' onclick='return expand(this);'>partSeperator<span class='references'><table></table></span></a></span> = <span class='string'>"\r\n"</span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>)!
<span class=lineno>0017</span>        <span class='builtin'>private</span> <span class='keyword'>static</span> <span class='keyword'>var</span> <span class='identifier'><a name='17_23' title='usrString2' onclick='return expand(this);'>headerSeperator<span class='references'><table></table></span></a></span> = <span class='string'>": "</span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>)!
<span class=lineno>0018</span>    
<span class=lineno>0019</span>        <span class='builtin'>public</span> <span class='keyword'>init</span>(<span class='identifier'><a name='19_16' href='#' title='usrString2' onclick='return expand(this);'>dataTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#20_29"; return false;'>MessageTransport.swift:20</td><td><pre>        self.dataTransport = dataTransport</pre></td></table></span></a></span>: <span class='typeidentifier'>DataTransport</span>) {
<span class=lineno>0020</span>            <span class='keyword'>self</span>.<span class='identifier'><a name='20_13' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span> = <span class='identifier'><a name='20_29' href='MessageTransport.html#19_16' title='usrString1'>dataTransport</a></span>
<span class=lineno>0021</span>            <span class='keyword'>self</span>.<span class='identifier'><a name='21_13' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span> = <span class='identifier'>Data</span>()
<span class=lineno>0022</span>    
<span class=lineno>0023</span>            <span class='identifier'><a name='23_8' href='MessageTransport.html#26_17' title='usrString1'>setupReadHandler</a></span>()
<span class=lineno>0024</span>        }
<span class=lineno>0025</span>    
<span class=lineno>0026</span>        <span class='builtin'>private</span> <span class='keyword'>func</span> <span class='identifier'><a name='26_17' href='#' title='usrString2' onclick='return expand(this);'>setupReadHandler<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#23_8"; return false;'>MessageTransport.swift:23</td><td><pre>        setupReadHandler()</pre></td></table></span></a></span>() {
<span class=lineno>0027</span>            <span class='identifier'><a name='27_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='27_22' href='DataTransport.html#15_9' title='usrString1'>setReaderHandler</a></span>({ [<span class='builtin'>unowned</span> <span class='keyword'>self</span>] (<span class='identifier'><a name='27_57' title='usrString3'>data</a></span>) <span class='keyword'>in</span>
<span class=lineno>0028</span>                <span class='keyword'>guard</span> <span class='identifier'><a name='28_18' href='MessageTransport.html#27_57' title='usrString1'>data</a></span>.<span class='identifier'>count</span> > <span class='number'>0</span> <span class='keyword'>else</span> {
<span class=lineno>0029</span>                    <span class='keyword'>return</span>
<span class=lineno>0030</span>                }
<span class=lineno>0031</span>    
<span class=lineno>0032</span>                <span class='keyword'>self</span>.<span class='identifier'><a name='32_17' href='MessageTransport.html#36_17' title='usrString1'>dataReceived</a></span>(<span class='identifier'><a name='32_30' href='MessageTransport.html#27_57' title='usrString1'>data</a></span>)
<span class=lineno>0033</span>            })
<span class=lineno>0034</span>        }
<span class=lineno>0035</span>    
<span class=lineno>0036</span>        <span class='builtin'>private</span> <span class='keyword'>func</span> <span class='identifier'><a name='36_17' href='#' title='usrString2' onclick='return expand(this);'>dataReceived<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#32_17"; return false;'>MessageTransport.swift:32</td><td><pre>            self.dataReceived(data)</pre></td></table></span></a></span>(<span class='keyword'>_</span> <span class='identifier'><a name='36_32' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>) {
<span class=lineno>0037</span>            <span class='identifier'><a name='37_8' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>append</span>(<span class='identifier'><a name='37_22' href='MessageTransport.html#36_32' title='usrString1'>data</a></span>)
<span class=lineno>0038</span>            
<span class=lineno>0039</span>            <span class='identifier'><a name='39_8' href='MessageTransport.html#42_17' title='usrString1'>checkBuffer</a></span>()
<span class=lineno>0040</span>        }
<span class=lineno>0041</span>    
<span class=lineno>0042</span>        <span class='builtin'>private</span> <span class='keyword'>func</span> <span class='identifier'><a name='42_17' href='#' title='usrString2' onclick='return expand(this);'>checkBuffer<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#39_8"; return false;'>MessageTransport.swift:39</td><td><pre>        checkBuffer()</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#62_12"; return false;'>MessageTransport.swift:62</td><td><pre>            checkBuffer()</pre></td></table></span></a></span>() {
<span class=lineno>0043</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='43_18' title='usrString3'>contentRange</a></span> = <span class='identifier'><a name='43_33' href='MessageTransport.html#66_17' title='usrString1'>readContentRange</a></span>(<span class='identifier'><a name='43_50' href='MessageTransport.html#66_17' title='usrString1'>in</a></span>: <span class='identifier'><a name='43_54' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>) <span class='keyword'>else</span> {
<span class=lineno>0044</span>                <span class='keyword'>return</span>
<span class=lineno>0045</span>            }
<span class=lineno>0046</span>    
<span class=lineno>0047</span>            <span class='keyword'>if</span> <span class='identifier'><a name='47_11' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>endIndex</span> &lt; <span class='identifier'><a name='47_29' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>.<span class='identifier'>upperBound</span> {
<span class=lineno>0048</span>                <span class='keyword'>return</span>
<span class=lineno>0049</span>            }
<span class=lineno>0050</span>    
<span class=lineno>0051</span>            <span class='keyword'>let</span> <span class='identifier'><a name='51_12' title='usrString3'>content</a></span> = <span class='identifier'><a name='51_22' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>subdata</span>(<span class='identifier'>in</span>: <span class='identifier'><a name='51_41' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>)
<span class=lineno>0052</span>            <span class='keyword'>let</span> <span class='identifier'><a name='52_12' title='usrString3'>messageRange</a></span> = <span class='identifier'><a name='52_27' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>startIndex</span>..&lt;<span class='identifier'><a name='52_47' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0053</span>    
<span class=lineno>0054</span>            <span class='identifier'>precondition</span>(<span class='identifier'><a name='54_21' href='MessageTransport.html#52_12' title='usrString1'>messageRange</a></span>.<span class='identifier'>count</span> > <span class='number'>0</span>)
<span class=lineno>0055</span>            
<span class=lineno>0056</span>            <span class='identifier'><a name='56_8' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>removeSubrange</span>(<span class='identifier'><a name='56_30' href='MessageTransport.html#52_12' title='usrString1'>messageRange</a></span>)
<span class=lineno>0057</span>    
<span class=lineno>0058</span>            <span class='keyword'>self</span>.<span class='identifier'><a name='58_13' href='MessageTransport.html#13_8' title='usrString1'>dataHandler</a></span>?(<span class='identifier'><a name='58_26' href='MessageTransport.html#51_12' title='usrString1'>content</a></span>)
<span class=lineno>0059</span>    
<span class=lineno>0060</span>            <span class='comment'>// call recursively *only* if we have removed some data
<span class=lineno>0061</span>    </span>        <span class='keyword'>if</span> !<span class='identifier'><a name='61_12' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'>isEmpty</span> {
<span class=lineno>0062</span>                <span class='identifier'><a name='62_12' href='MessageTransport.html#42_17' title='usrString1'>checkBuffer</a></span>()
<span class=lineno>0063</span>            }
<span class=lineno>0064</span>        }
<span class=lineno>0065</span>    
<span class=lineno>0066</span>        <span class='builtin'>private</span> <span class='keyword'>func</span> <span class='identifier'><a name='66_17' href='#' title='usrString2' onclick='return expand(this);'>readContentRange<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#43_33"; return false;'>MessageTransport.swift:43</td><td><pre>        guard let contentRange = readContentRange(in: buffer) else {</pre></td></table></span></a></span>(<span class='identifier'><a name='66_34' href='MessageTransport.html#66_17' title='usrString1'>in</a></span> <span class='identifier'><a name='66_37' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>) -> <span class='typeidentifier'>Range</span>&lt;<span class='typeidentifier'>Data</span>.<span class='typeidentifier'>Index</span>>? {
<span class=lineno>0067</span>            <span class='keyword'>let</span> <span class='identifier'><a name='67_12' title='usrString3'>seperator</a></span> = <span class='string'>"\r\n\r\n"</span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>)!
<span class=lineno>0068</span>            
<span class=lineno>0069</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='69_18' title='usrString3'>range</a></span> = <span class='identifier'><a name='69_26' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>.<span class='identifier'>range</span>(<span class='identifier'>of</span>: <span class='identifier'><a name='69_41' href='MessageTransport.html#67_12' title='usrString1'>seperator</a></span>) <span class='keyword'>else</span> {
<span class=lineno>0070</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0071</span>            }
<span class=lineno>0072</span>            
<span class=lineno>0073</span>            <span class='keyword'>let</span> <span class='identifier'><a name='73_12' title='usrString3'>headersSectionRange</a></span> = <span class='identifier'><a name='73_34' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>.<span class='identifier'>startIndex</span>..&lt;<span class='identifier'><a name='73_52' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'>lowerBound</span>
<span class=lineno>0074</span>            
<span class=lineno>0075</span>            <span class='keyword'>let</span> <span class='identifier'><a name='75_12' title='usrString3'>headers</a></span> = <span class='identifier'><a name='75_22' href='MessageTransport.html#90_17' title='usrString1'>readHeaders</a></span>(<span class='identifier'><a name='75_34' href='MessageTransport.html#90_17' title='usrString1'>from</a></span>: <span class='identifier'><a name='75_40' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>, <span class='identifier'><a name='75_46' href='MessageTransport.html#90_17' title='usrString1'>in</a></span>: <span class='identifier'><a name='75_50' href='MessageTransport.html#73_12' title='usrString1'>headersSectionRange</a></span>)
<span class=lineno>0076</span>            
<span class=lineno>0077</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='77_18' title='usrString3'>lengthValue</a></span> = <span class='identifier'><a name='77_32' href='MessageTransport.html#75_12' title='usrString1'>headers</a></span>[<span class='string'>"Content-Length"</span>] <span class='keyword'>else</span> {
<span class=lineno>0078</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0079</span>            }
<span class=lineno>0080</span>            
<span class=lineno>0081</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='81_18' title='usrString3'>length</a></span> = <span class='identifier'>Int</span>(<span class='identifier'><a name='81_31' href='MessageTransport.html#77_18' title='usrString1'>lengthValue</a></span>) <span class='keyword'>else</span> {
<span class=lineno>0082</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0083</span>            }
<span class=lineno>0084</span>            
<span class=lineno>0085</span>            <span class='keyword'>let</span> <span class='identifier'><a name='85_12' title='usrString3'>upperLimit</a></span> = <span class='identifier'><a name='85_25' href='MessageTransport.html#81_18' title='usrString1'>length</a></span> + <span class='identifier'><a name='85_34' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0086</span>            
<span class=lineno>0087</span>            <span class='keyword'>return</span> <span class='identifier'><a name='87_15' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>..&lt;<span class='identifier'><a name='87_34' href='MessageTransport.html#85_12' title='usrString1'>upperLimit</a></span>
<span class=lineno>0088</span>        }
<span class=lineno>0089</span>        
<span class=lineno>0090</span>        <span class='builtin'>private</span> <span class='keyword'>func</span> <span class='identifier'><a name='90_17' href='#' title='usrString2' onclick='return expand(this);'>readHeaders<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#75_22"; return false;'>MessageTransport.swift:75</td><td><pre>        let headers = readHeaders(from: data, in: headersSectionRange)</pre></td></table></span></a></span>(<span class='identifier'><a name='90_29' href='MessageTransport.html#90_17' title='usrString1'>from</a></span> <span class='identifier'><a name='90_34' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>, <span class='identifier'><a name='90_46' href='MessageTransport.html#90_17' title='usrString1'>in</a></span> <span class='identifier'><a name='90_49' title='usrString2' onclick='return expand(this);'>range<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Range</span>&lt;<span class='typeidentifier'>Data</span>.<span class='typeidentifier'>Index</span>>) -> [<span class='typeidentifier'>String</span>: <span class='typeidentifier'>String</span>] {
<span class=lineno>0091</span>            <span class='keyword'>var</span> <span class='identifier'><a name='91_12' title='usrString3'>headers</a></span>: [<span class='typeidentifier'>String</span>: <span class='typeidentifier'>String</span>] = [:]
<span class=lineno>0092</span>    
<span class=lineno>0093</span>            <span class='keyword'>var</span> <span class='identifier'><a name='93_12' title='usrString3'>location</a></span> = <span class='identifier'><a name='93_23' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'>lowerBound</span>
<span class=lineno>0094</span>            
<span class=lineno>0095</span>            <span class='keyword'>while</span> <span class='identifier'><a name='95_14' href='MessageTransport.html#93_12' title='usrString1'>location</a></span> &lt; <span class='identifier'><a name='95_25' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span> {
<span class=lineno>0096</span>                <span class='keyword'>let</span> <span class='identifier'><a name='96_16' title='usrString3'>searchRange</a></span> = <span class='identifier'><a name='96_30' href='MessageTransport.html#93_12' title='usrString1'>location</a></span>..&lt;<span class='identifier'><a name='96_41' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0097</span>                
<span class=lineno>0098</span>                <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='98_22' title='usrString3'>headerData</a></span> = <span class='identifier'><a name='98_35' href='MessageTransport.html#112_9' title='usrString1'>readHeader</a></span>(<span class='identifier'><a name='98_46' href='MessageTransport.html#112_9' title='usrString1'>in</a></span>: <span class='identifier'><a name='98_50' href='MessageTransport.html#90_34' title='usrString1'>data</a></span>, <span class='identifier'><a name='98_56' href='MessageTransport.html#112_9' title='usrString1'>range</a></span>: <span class='identifier'><a name='98_63' href='MessageTransport.html#96_16' title='usrString1'>searchRange</a></span>) <span class='keyword'>else</span> {
<span class=lineno>0099</span>                    <span class='keyword'>break</span>
<span class=lineno>0100</span>                }
<span class=lineno>0101</span>                
<span class=lineno>0102</span>                <span class='keyword'>let</span> (<span class='identifier'><a name='102_17' title='usrString3'>key</a></span>, <span class='identifier'><a name='102_22' title='usrString3'>value</a></span>, <span class='identifier'><a name='102_29' title='usrString3'>limit</a></span>) = <span class='identifier'><a name='102_38' href='MessageTransport.html#98_22' title='usrString1'>headerData</a></span>
<span class=lineno>0103</span>                
<span class=lineno>0104</span>                <span class='identifier'><a name='104_12' href='MessageTransport.html#91_12' title='usrString1'>headers</a></span>[<span class='identifier'><a name='104_20' href='MessageTransport.html#102_17' title='usrString1'>key</a></span>] = <span class='identifier'><a name='104_27' href='MessageTransport.html#102_22' title='usrString1'>value</a></span>
<span class=lineno>0105</span>                
<span class=lineno>0106</span>                <span class='identifier'><a name='106_12' href='MessageTransport.html#93_12' title='usrString1'>location</a></span> = <span class='identifier'><a name='106_23' href='MessageTransport.html#102_29' title='usrString1'>limit</a></span>
<span class=lineno>0107</span>            }
<span class=lineno>0108</span>            
<span class=lineno>0109</span>            <span class='keyword'>return</span> <span class='identifier'><a name='109_15' href='MessageTransport.html#91_12' title='usrString1'>headers</a></span>
<span class=lineno>0110</span>        }
<span class=lineno>0111</span>        
<span class=lineno>0112</span>        <span class='keyword'>func</span> <span class='identifier'><a name='112_9' href='#' title='usrString2' onclick='return expand(this);'>readHeader<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#98_35"; return false;'>MessageTransport.swift:98</td><td><pre>            guard let headerData = readHeader(in: data, range: searchRange) else {</pre></td></table></span></a></span>(<span class='identifier'><a name='112_20' href='MessageTransport.html#112_9' title='usrString1'>in</a></span> <span class='identifier'><a name='112_23' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>, <span class='identifier'><a name='112_35' href='#' title='usrString2' onclick='return expand(this);'>range<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#116_84"; return false;'>MessageTransport.swift:116</td><td><pre>        guard let seperatorRange = data.range(of: headerSeperator, options: [], in: range) else {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#120_23"; return false;'>MessageTransport.swift:120</td><td><pre>        let keyRange = range.lowerBound..&lt;seperatorRange.lowerBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#121_61"; return false;'>MessageTransport.swift:121</td><td><pre>        let postSeperatorRange = seperatorRange.upperBound..&lt;range.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#124_61"; return false;'>MessageTransport.swift:124</td><td><pre>        let valueUpperBound = terminatorRange?.lowerBound ?? range.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#138_57"; return false;'>MessageTransport.swift:138</td><td><pre>        let endOfHeader = terminatorRange?.upperBound ?? range.upperBound</pre></td></table></span></a></span>: <span class='typeidentifier'>Range</span>&lt;<span class='typeidentifier'>Data</span>.<span class='typeidentifier'>Index</span>>) -> (<span class='typeidentifier'>String</span>, <span class='typeidentifier'>String</span>, <span class='typeidentifier'>Data</span>.<span class='typeidentifier'>Index</span>)? {
<span class=lineno>0113</span>            <span class='keyword'>let</span> <span class='identifier'><a name='113_12' title='usrString3'>seperator</a></span> = <span class='string'>"\r\n"</span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>)!
<span class=lineno>0114</span>            <span class='keyword'>let</span> <span class='identifier'><a name='114_12' title='usrString3'>headerSeperator</a></span> = <span class='string'>": "</span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>)!
<span class=lineno>0115</span>            
<span class=lineno>0116</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='116_18' title='usrString3'>seperatorRange</a></span> = <span class='identifier'><a name='116_35' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'>range</span>(<span class='identifier'>of</span>: <span class='identifier'><a name='116_50' href='MessageTransport.html#114_12' title='usrString1'>headerSeperator</a></span>, <span class='identifier'>options</span>: [], <span class='identifier'>in</span>: <span class='identifier'><a name='116_84' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>) <span class='keyword'>else</span> {
<span class=lineno>0117</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0118</span>            }
<span class=lineno>0119</span>            
<span class=lineno>0120</span>            <span class='keyword'>let</span> <span class='identifier'><a name='120_12' title='usrString3'>keyRange</a></span> = <span class='identifier'><a name='120_23' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'>lowerBound</span>..&lt;<span class='identifier'><a name='120_42' href='MessageTransport.html#116_18' title='usrString1'>seperatorRange</a></span>.<span class='identifier'>lowerBound</span>
<span class=lineno>0121</span>            <span class='keyword'>let</span> <span class='identifier'><a name='121_12' title='usrString3'>postSeperatorRange</a></span> = <span class='identifier'><a name='121_33' href='MessageTransport.html#116_18' title='usrString1'>seperatorRange</a></span>.<span class='identifier'>upperBound</span>..&lt;<span class='identifier'><a name='121_61' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0122</span>            
<span class=lineno>0123</span>            <span class='keyword'>let</span> <span class='identifier'><a name='123_12' title='usrString3'>terminatorRange</a></span> = <span class='identifier'><a name='123_30' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'>range</span>(<span class='identifier'>of</span>: <span class='identifier'><a name='123_45' href='MessageTransport.html#113_12' title='usrString1'>seperator</a></span>, <span class='identifier'>options</span>: [], <span class='identifier'>in</span>: <span class='identifier'><a name='123_73' href='MessageTransport.html#121_12' title='usrString1'>postSeperatorRange</a></span>)
<span class=lineno>0124</span>            <span class='keyword'>let</span> <span class='identifier'><a name='124_12' title='usrString3'>valueUpperBound</a></span> = <span class='identifier'><a name='124_30' href='MessageTransport.html#123_12' title='usrString1'>terminatorRange</a></span>?.<span class='identifier'>lowerBound</span> ?? <span class='identifier'><a name='124_61' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0125</span>            <span class='keyword'>let</span> <span class='identifier'><a name='125_12' title='usrString3'>valueRange</a></span> = <span class='identifier'><a name='125_25' href='MessageTransport.html#121_12' title='usrString1'>postSeperatorRange</a></span>.<span class='identifier'>lowerBound</span>..&lt;<span class='identifier'><a name='125_57' href='MessageTransport.html#124_12' title='usrString1'>valueUpperBound</a></span>
<span class=lineno>0126</span>            
<span class=lineno>0127</span>            <span class='keyword'>let</span> <span class='identifier'><a name='127_12' title='usrString3'>keyData</a></span> = <span class='identifier'><a name='127_22' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'>subdata</span>(<span class='identifier'>in</span>: <span class='identifier'><a name='127_39' href='MessageTransport.html#120_12' title='usrString1'>keyRange</a></span>)
<span class=lineno>0128</span>            <span class='keyword'>let</span> <span class='identifier'><a name='128_12' title='usrString3'>valueData</a></span> = <span class='identifier'><a name='128_24' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'>subdata</span>(<span class='identifier'>in</span>: <span class='identifier'><a name='128_41' href='MessageTransport.html#125_12' title='usrString1'>valueRange</a></span>)
<span class=lineno>0129</span>            
<span class=lineno>0130</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='130_18' title='usrString3'>key</a></span> = <span class='identifier'>String</span>(<span class='identifier'>data</span>: <span class='identifier'><a name='130_37' href='MessageTransport.html#127_12' title='usrString1'>keyData</a></span>, <span class='identifier'>encoding</span>: .<span class='identifier'>utf8</span>) <span class='keyword'>else</span> {
<span class=lineno>0131</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0132</span>            }
<span class=lineno>0133</span>    
<span class=lineno>0134</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='134_18' title='usrString3'>value</a></span> = <span class='identifier'>String</span>(<span class='identifier'>data</span>: <span class='identifier'><a name='134_39' href='MessageTransport.html#128_12' title='usrString1'>valueData</a></span>, <span class='identifier'>encoding</span>: .<span class='identifier'>utf8</span>) <span class='keyword'>else</span> {
<span class=lineno>0135</span>                <span class='keyword'>return</span> <span class='keyword'>nil</span>
<span class=lineno>0136</span>            }
<span class=lineno>0137</span>            
<span class=lineno>0138</span>            <span class='keyword'>let</span> <span class='identifier'><a name='138_12' title='usrString3'>endOfHeader</a></span> = <span class='identifier'><a name='138_26' href='MessageTransport.html#123_12' title='usrString1'>terminatorRange</a></span>?.<span class='identifier'>upperBound</span> ?? <span class='identifier'><a name='138_57' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'>upperBound</span>
<span class=lineno>0139</span>            
<span class=lineno>0140</span>            <span class='keyword'>return</span> (<span class='identifier'><a name='140_16' href='MessageTransport.html#130_18' title='usrString1'>key</a></span>, <span class='identifier'><a name='140_21' href='MessageTransport.html#134_18' title='usrString1'>value</a></span>, <span class='identifier'><a name='140_28' href='MessageTransport.html#138_12' title='usrString1'>endOfHeader</a></span>)
<span class=lineno>0141</span>        }
<span class=lineno>0142</span>        
<span class=lineno>0143</span>        <span class='builtin'>public</span> <span class='keyword'>static</span> <span class='keyword'>func</span> <span class='identifier'><a name='143_23' href='#' title='usrString2' onclick='return expand(this);'>createMessage<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#157_43"; return false;'>MessageTransport.swift:157</td><td><pre>        let messageData = MessageTransport.createMessage(with: data)</pre></td></table></span></a></span>(<span class='identifier'><a name='143_37' href='MessageTransport.html#143_23' title='usrString1'>with</a></span> <span class='identifier'><a name='143_42' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>) -> <span class='typeidentifier'>Data</span> {
<span class=lineno>0144</span>            <span class='keyword'>let</span> <span class='identifier'><a name='144_12' title='usrString3'>length</a></span> = <span class='identifier'><a name='144_21' href='MessageTransport.html#143_42' title='usrString1'>data</a></span>.<span class='identifier'>count</span>
<span class=lineno>0145</span>    
<span class=lineno>0146</span>            <span class='keyword'>let</span> <span class='identifier'><a name='146_12' title='usrString3'>header</a></span> = <span class='string'>"Content-Length: </span>\<span class='string_interpolation_anchor'>(</span><span class='identifier'><a name='146_40' href='MessageTransport.html#144_12' title='usrString1'>length</a></span><span class='string_interpolation_anchor'>)</span><span class='string'>\r\n\r\n"</span>
<span class=lineno>0147</span>            <span class='keyword'>guard</span> <span class='keyword'>let</span> <span class='identifier'><a name='147_18' title='usrString3'>headerData</a></span> = <span class='identifier'><a name='147_31' href='MessageTransport.html#146_12' title='usrString1'>header</a></span>.<span class='identifier'>data</span>(<span class='identifier'>using</span>: .<span class='identifier'>utf8</span>) <span class='keyword'>else</span> {
<span class=lineno>0148</span>                <span class='identifier'>fatalError</span>()
<span class=lineno>0149</span>            }
<span class=lineno>0150</span>    
<span class=lineno>0151</span>            <span class='keyword'>return</span> <span class='identifier'><a name='151_15' href='MessageTransport.html#147_18' title='usrString1'>headerData</a></span> + <span class='identifier'><a name='151_28' href='MessageTransport.html#143_42' title='usrString1'>data</a></span>
<span class=lineno>0152</span>        }
<span class=lineno>0153</span>    }
<span class=lineno>0154</span>    
<span class=lineno>0155</span>    <span class='keyword'>extension</span> <span class='typeidentifier'>MessageTransport</span>: <span class='typeidentifier'>DataTransport</span> {
<span class=lineno>0156</span>        <span class='builtin'>public</span> <span class='keyword'>func</span> <span class='identifier'><a name='156_16' href='#' title='usrString2' onclick='return expand(this);'>write<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#77_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:77</td><td><pre>            self.messageTransport.write(jsonData)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#115_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:115</td><td><pre>            self.messageTransport.write(jsonData)</pre></td></table></span></a></span>(<span class='keyword'>_</span> <span class='identifier'><a name='156_24' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'>Data</span>) {
<span class=lineno>0157</span>            <span class='keyword'>let</span> <span class='identifier'><a name='157_12' title='usrString3'>messageData</a></span> = <span class='identifier'><a name='157_26' href='MessageTransport.html#11_13' title='usrString1'>MessageTransport</a></span>.<span class='identifier'><a name='157_43' href='MessageTransport.html#143_23' title='usrString1'>createMessage</a></span>(<span class='identifier'><a name='157_57' href='MessageTransport.html#143_23' title='usrString1'>with</a></span>: <span class='identifier'><a name='157_63' href='MessageTransport.html#156_24' title='usrString1'>data</a></span>)
<span class=lineno>0158</span>    
<span class=lineno>0159</span>            <span class='identifier'><a name='159_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='159_22' href='DataTransport.html#14_9' title='usrString1'>write</a></span>(<span class='identifier'><a name='159_28' href='MessageTransport.html#157_12' title='usrString1'>messageData</a></span>)
<span class=lineno>0160</span>        }
<span class=lineno>0161</span>    
<span class=lineno>0162</span>        <span class='builtin'>public</span> <span class='keyword'>func</span> <span class='identifier'><a name='162_16' title='usrString2' onclick='return expand(this);'>setReaderHandler<span class='references'><table></table></span></a></span>(<span class='keyword'>_</span> <span class='identifier'><a name='162_35' title='usrString2' onclick='return expand(this);'>handler<span class='references'><table></table></span></a></span>: <span class='builtin'>@escaping</span> <span class='typeidentifier'>DataTransport</span>.<span class='typeidentifier'>ReadHandler</span>) {
<span class=lineno>0163</span>            <span class='keyword'>self</span>.<span class='identifier'><a name='163_13' href='MessageTransport.html#13_8' title='usrString1'>dataHandler</a></span> = <span class='identifier'><a name='163_27' href='MessageTransport.html#162_35' title='usrString1'>handler</a></span>
<span class=lineno>0164</span>        }
<span class=lineno>0165</span>    
<span class=lineno>0166</span>        <span class='builtin'>public</span> <span class='keyword'>func</span> <span class='identifier'><a name='166_16' title='usrString2' onclick='return expand(this);'>close<span class='references'><table></table></span></a></span>() {
<span class=lineno>0167</span>            <span class='identifier'><a name='167_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='167_22' href='DataTransport.html#17_9' title='usrString1'>close</a></span>()
<span class=lineno>0168</span>        }
<span class=lineno>0169</span>    }
<span class=lineno>0170</span>    