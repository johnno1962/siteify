<html><head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="siteify.css">
<script>

var lastlink;

function expand(a) {
    if ( a.children[0].style.display != "block" ) {
        if ( lastlink )
            lastlink.style.display = "none";
        a.children[0].style.display = "block";
        lastlink = a.children[0];
    }
    else {
        a.children[0].style.display = "none";
        lastlink = null;
    }
    return false;
}

</script></head><body><pre>0001    <span class='comment'><a name='1_0'>//
0002    </a></span><span class='comment'><a name='2_0'>//  MessageTransport.swift
0003    </a></span><span class='comment'><a name='3_0'>//  SwiftLSPClient
0004    </a></span><span class='comment'><a name='4_0'>//
0005    </a></span><span class='comment'><a name='5_0'>//  Created by Matt Massicotte on 2018-10-15.
0006    </a></span><span class='comment'><a name='6_0'>//  Copyright Â© 2018 Chime Systems. All rights reserved.
0007    </a></span><span class='comment'><a name='7_0'>//
0008    </a></span>
0009    <span class='keyword'><a name='9_0'>import</a></span> <span class='identifier'><a name='9_7'>Foundation</a></span>
0010    
0011    <span class='builtin'><a name='11_0'>public</a></span> <span class='keyword'><a name='11_7'>class</a></span> <span class='identifier'><a name='11_13' href='#' title='usrString2' onclick='return expand(this);'>MessageTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#155_10"; return false;'>MessageTransport.swift:155</td><td><pre>extension MessageTransport: DataTransport {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#157_26"; return false;'>MessageTransport.swift:157</td><td><pre>        let messageData = MessageTransport.createMessage(with: data)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#29_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:29</td><td><pre>    private let messageTransport: MessageTransport</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#36_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:36</td><td><pre>    public init(messageTransport: MessageTransport) {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#49_31"; event.stopPropagation(); return false;'>ProtocolTransport.swift:49</td><td><pre>        let messageTransport = MessageTransport(dataTransport: dataTransport)</pre></td></table></span></a></span> {
0012        <span class='builtin'><a name='12_4'>private</a></span> <span class='keyword'><a name='12_12'>let</a></span> <span class='identifier'><a name='12_16' href='#' title='usrString2' onclick='return expand(this);'>dataTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#20_13"; return false;'>MessageTransport.swift:20</td><td><pre>        self.dataTransport = dataTransport</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#27_8"; return false;'>MessageTransport.swift:27</td><td><pre>        dataTransport.setReaderHandler({ [unowned self] (data) in</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#159_8"; return false;'>MessageTransport.swift:159</td><td><pre>        dataTransport.write(messageData)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#167_8"; return false;'>MessageTransport.swift:167</td><td><pre>        dataTransport.close()</pre></td></table></span></a></span>: <span class='typeidentifier'><a name='12_31'>DataTransport</a></span>
0013        <span class='keyword'><a name='13_4'>var</a></span> <span class='identifier'><a name='13_8' href='#' title='usrString2' onclick='return expand(this);'>dataHandler<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#58_13"; return false;'>MessageTransport.swift:58</td><td><pre>        self.dataHandler?(content)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#163_13"; return false;'>MessageTransport.swift:163</td><td><pre>        self.dataHandler = handler</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#43_30"; event.stopPropagation(); return false;'>ProtocolTransport.swift:43</td><td><pre>        self.messageTransport.dataHandler = { [unowned self] (data) in</pre></td></table></span></a></span>: <span class='typeidentifier'><a name='13_21'>DataTransport</a></span>.<span class='typeidentifier'><a name='13_35'>ReadHandler</a></span>?
0014        <span class='builtin'><a name='14_4'>private</a></span> <span class='keyword'><a name='14_12'>var</a></span> <span class='identifier'><a name='14_16' href='#' title='usrString2' onclick='return expand(this);'>buffer<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#21_13"; return false;'>MessageTransport.swift:21</td><td><pre>        self.buffer = Data()</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#37_8"; return false;'>MessageTransport.swift:37</td><td><pre>        buffer.append(data)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#43_54"; return false;'>MessageTransport.swift:43</td><td><pre>        guard let contentRange = readContentRange(in: buffer) else {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#47_11"; return false;'>MessageTransport.swift:47</td><td><pre>        if buffer.endIndex &lt; contentRange.upperBound {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#51_22"; return false;'>MessageTransport.swift:51</td><td><pre>        let content = buffer.subdata(in: contentRange)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#52_27"; return false;'>MessageTransport.swift:52</td><td><pre>        let messageRange = buffer.startIndex..&lt;contentRange.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#56_8"; return false;'>MessageTransport.swift:56</td><td><pre>        buffer.removeSubrange(messageRange)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#61_12"; return false;'>MessageTransport.swift:61</td><td><pre>        if !buffer.isEmpty {</pre></td></table></span></a></span>: <span class='typeidentifier'><a name='14_24'>Data</a></span>
0015        
0016        <span class='builtin'><a name='16_4'>private</a></span> <span class='keyword'><a name='16_12'>static</a></span> <span class='keyword'><a name='16_19'>var</a></span> <span class='identifier'><a name='16_23' title='usrString2' onclick='return expand(this);'>partSeperator<span class='references'><table></table></span></a></span> = <span class='string'><a name='16_39'>"\r\n"</a></span>.<span class='identifier'><a name='16_46'>data</a></span>(<span class='identifier'><a name='16_51'>using</a></span>: .<span class='identifier'><a name='16_59'>utf8</a></span>)!
0017        <span class='builtin'><a name='17_4'>private</a></span> <span class='keyword'><a name='17_12'>static</a></span> <span class='keyword'><a name='17_19'>var</a></span> <span class='identifier'><a name='17_23' title='usrString2' onclick='return expand(this);'>headerSeperator<span class='references'><table></table></span></a></span> = <span class='string'><a name='17_41'>": "</a></span>.<span class='identifier'><a name='17_46'>data</a></span>(<span class='identifier'><a name='17_51'>using</a></span>: .<span class='identifier'><a name='17_59'>utf8</a></span>)!
0018    
0019        <span class='builtin'><a name='19_4'>public</a></span> <span class='keyword'><a name='19_11'>init</a></span>(<span class='identifier'><a name='19_16' href='#' title='usrString2' onclick='return expand(this);'>dataTransport<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#20_29"; return false;'>MessageTransport.swift:20</td><td><pre>        self.dataTransport = dataTransport</pre></td></table></span></a></span>: <span class='typeidentifier'><a name='19_31'>DataTransport</a></span>) {
0020            <span class='keyword'><a name='20_8'>self</a></span>.<span class='identifier'><a name='20_13' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span> = <span class='identifier'><a name='20_29' href='MessageTransport.html#19_16' title='usrString1'>dataTransport</a></span>
0021            <span class='keyword'><a name='21_8'>self</a></span>.<span class='identifier'><a name='21_13' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span> = <span class='identifier'><a name='21_22'>Data</a></span>()
0022    
0023            <span class='identifier'><a name='23_8' href='MessageTransport.html#26_17' title='usrString1'>setupReadHandler</a></span>()
0024        }
0025    
0026        <span class='builtin'><a name='26_4'>private</a></span> <span class='keyword'><a name='26_12'>func</a></span> <span class='identifier'><a name='26_17' href='#' title='usrString2' onclick='return expand(this);'>setupReadHandler<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#23_8"; return false;'>MessageTransport.swift:23</td><td><pre>        setupReadHandler()</pre></td></table></span></a></span>() {
0027            <span class='identifier'><a name='27_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='27_22' href='DataTransport.html#15_9' title='usrString1'>setReaderHandler</a></span>({ [<span class='builtin'><a name='27_42'>unowned</a></span> <span class='keyword'><a name='27_50'>self</a></span>] (<span class='identifier'><a name='27_57' title='usrString3'>data</a></span>) <span class='keyword'><a name='27_63'>in</a></span>
0028                <span class='keyword'><a name='28_12'>guard</a></span> <span class='identifier'><a name='28_18' href='MessageTransport.html#27_57' title='usrString1'>data</a></span>.<span class='identifier'><a name='28_23'>count</a></span> > <span class='number'><a name='28_31'>0</a></span> <span class='keyword'><a name='28_33'>else</a></span> {
0029                    <span class='keyword'><a name='29_16'>return</a></span>
0030                }
0031    
0032                <span class='keyword'><a name='32_12'>self</a></span>.<span class='identifier'><a name='32_17' href='MessageTransport.html#36_17' title='usrString1'>dataReceived</a></span>(<span class='identifier'><a name='32_30' href='MessageTransport.html#27_57' title='usrString1'>data</a></span>)
0033            })
0034        }
0035    
0036        <span class='builtin'><a name='36_4'>private</a></span> <span class='keyword'><a name='36_12'>func</a></span> <span class='identifier'><a name='36_17' href='#' title='usrString2' onclick='return expand(this);'>dataReceived<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#32_17"; return false;'>MessageTransport.swift:32</td><td><pre>            self.dataReceived(data)</pre></td></table></span></a></span>(<span class='keyword'><a name='36_30'>_</a></span> <span class='identifier'><a name='36_32' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='36_38'>Data</a></span>) {
0037            <span class='identifier'><a name='37_8' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='37_15'>append</a></span>(<span class='identifier'><a name='37_22' href='MessageTransport.html#36_32' title='usrString1'>data</a></span>)
0038            
0039            <span class='identifier'><a name='39_8' href='MessageTransport.html#42_17' title='usrString1'>checkBuffer</a></span>()
0040        }
0041    
0042        <span class='builtin'><a name='42_4'>private</a></span> <span class='keyword'><a name='42_12'>func</a></span> <span class='identifier'><a name='42_17' href='#' title='usrString2' onclick='return expand(this);'>checkBuffer<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#39_8"; return false;'>MessageTransport.swift:39</td><td><pre>        checkBuffer()</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#62_12"; return false;'>MessageTransport.swift:62</td><td><pre>            checkBuffer()</pre></td></table></span></a></span>() {
0043            <span class='keyword'><a name='43_8'>guard</a></span> <span class='keyword'><a name='43_14'>let</a></span> <span class='identifier'><a name='43_18' title='usrString3'>contentRange</a></span> = <span class='identifier'><a name='43_33' href='MessageTransport.html#66_17' title='usrString1'>readContentRange</a></span>(<span class='identifier'><a name='43_50' href='MessageTransport.html#66_17' title='usrString1'>in</a></span>: <span class='identifier'><a name='43_54' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>) <span class='keyword'><a name='43_62'>else</a></span> {
0044                <span class='keyword'><a name='44_12'>return</a></span>
0045            }
0046    
0047            <span class='keyword'><a name='47_8'>if</a></span> <span class='identifier'><a name='47_11' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='47_18'>endIndex</a></span> &lt; <span class='identifier'><a name='47_29' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>.<span class='identifier'><a name='47_42'>upperBound</a></span> {
0048                <span class='keyword'><a name='48_12'>return</a></span>
0049            }
0050    
0051            <span class='keyword'><a name='51_8'>let</a></span> <span class='identifier'><a name='51_12' title='usrString3'>content</a></span> = <span class='identifier'><a name='51_22' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='51_29'>subdata</a></span>(<span class='identifier'><a name='51_37'>in</a></span>: <span class='identifier'><a name='51_41' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>)
0052            <span class='keyword'><a name='52_8'>let</a></span> <span class='identifier'><a name='52_12' title='usrString3'>messageRange</a></span> = <span class='identifier'><a name='52_27' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='52_34'>startIndex</a></span>..&lt;<span class='identifier'><a name='52_47' href='MessageTransport.html#43_18' title='usrString1'>contentRange</a></span>.<span class='identifier'><a name='52_60'>upperBound</a></span>
0053    
0054            <span class='identifier'><a name='54_8'>precondition</a></span>(<span class='identifier'><a name='54_21' href='MessageTransport.html#52_12' title='usrString1'>messageRange</a></span>.<span class='identifier'><a name='54_34'>count</a></span> > <span class='number'><a name='54_42'>0</a></span>)
0055            
0056            <span class='identifier'><a name='56_8' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='56_15'>removeSubrange</a></span>(<span class='identifier'><a name='56_30' href='MessageTransport.html#52_12' title='usrString1'>messageRange</a></span>)
0057    
0058            <span class='keyword'><a name='58_8'>self</a></span>.<span class='identifier'><a name='58_13' href='MessageTransport.html#13_8' title='usrString1'>dataHandler</a></span>?(<span class='identifier'><a name='58_26' href='MessageTransport.html#51_12' title='usrString1'>content</a></span>)
0059    
0060            <span class='comment'><a name='60_8'>// call recursively *only* if we have removed some data
0061    </a></span>        <span class='keyword'><a name='61_8'>if</a></span> !<span class='identifier'><a name='61_12' href='MessageTransport.html#14_16' title='usrString1'>buffer</a></span>.<span class='identifier'><a name='61_19'>isEmpty</a></span> {
0062                <span class='identifier'><a name='62_12' href='MessageTransport.html#42_17' title='usrString1'>checkBuffer</a></span>()
0063            }
0064        }
0065    
0066        <span class='builtin'><a name='66_4'>private</a></span> <span class='keyword'><a name='66_12'>func</a></span> <span class='identifier'><a name='66_17' href='#' title='usrString2' onclick='return expand(this);'>readContentRange<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#43_33"; return false;'>MessageTransport.swift:43</td><td><pre>        guard let contentRange = readContentRange(in: buffer) else {</pre></td></table></span></a></span>(<span class='identifier'><a name='66_34' href='MessageTransport.html#66_17' title='usrString1'>in</a></span> <span class='identifier'><a name='66_37' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='66_43'>Data</a></span>) -> <span class='typeidentifier'><a name='66_52'>Range</a></span>&lt;<span class='typeidentifier'><a name='66_58'>Data</a></span>.<span class='typeidentifier'><a name='66_63'>Index</a></span>>? {
0067            <span class='keyword'><a name='67_8'>let</a></span> <span class='identifier'><a name='67_12' title='usrString3'>seperator</a></span> = <span class='string'><a name='67_24'>"\r\n\r\n"</a></span>.<span class='identifier'><a name='67_35'>data</a></span>(<span class='identifier'><a name='67_40'>using</a></span>: .<span class='identifier'><a name='67_48'>utf8</a></span>)!
0068            
0069            <span class='keyword'><a name='69_8'>guard</a></span> <span class='keyword'><a name='69_14'>let</a></span> <span class='identifier'><a name='69_18' title='usrString3'>range</a></span> = <span class='identifier'><a name='69_26' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>.<span class='identifier'><a name='69_31'>range</a></span>(<span class='identifier'><a name='69_37'>of</a></span>: <span class='identifier'><a name='69_41' href='MessageTransport.html#67_12' title='usrString1'>seperator</a></span>) <span class='keyword'><a name='69_52'>else</a></span> {
0070                <span class='keyword'><a name='70_12'>return</a></span> <span class='keyword'><a name='70_19'>nil</a></span>
0071            }
0072            
0073            <span class='keyword'><a name='73_8'>let</a></span> <span class='identifier'><a name='73_12' title='usrString3'>headersSectionRange</a></span> = <span class='identifier'><a name='73_34' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>.<span class='identifier'><a name='73_39'>startIndex</a></span>..&lt;<span class='identifier'><a name='73_52' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'><a name='73_58'>lowerBound</a></span>
0074            
0075            <span class='keyword'><a name='75_8'>let</a></span> <span class='identifier'><a name='75_12' title='usrString3'>headers</a></span> = <span class='identifier'><a name='75_22' href='MessageTransport.html#90_17' title='usrString1'>readHeaders</a></span>(<span class='identifier'><a name='75_34' href='MessageTransport.html#90_17' title='usrString1'>from</a></span>: <span class='identifier'><a name='75_40' href='MessageTransport.html#66_37' title='usrString1'>data</a></span>, <span class='identifier'><a name='75_46' href='MessageTransport.html#90_17' title='usrString1'>in</a></span>: <span class='identifier'><a name='75_50' href='MessageTransport.html#73_12' title='usrString1'>headersSectionRange</a></span>)
0076            
0077            <span class='keyword'><a name='77_8'>guard</a></span> <span class='keyword'><a name='77_14'>let</a></span> <span class='identifier'><a name='77_18' title='usrString3'>lengthValue</a></span> = <span class='identifier'><a name='77_32' href='MessageTransport.html#75_12' title='usrString1'>headers</a></span>[<span class='string'><a name='77_40'>"Content-Length"</a></span>] <span class='keyword'><a name='77_58'>else</a></span> {
0078                <span class='keyword'><a name='78_12'>return</a></span> <span class='keyword'><a name='78_19'>nil</a></span>
0079            }
0080            
0081            <span class='keyword'><a name='81_8'>guard</a></span> <span class='keyword'><a name='81_14'>let</a></span> <span class='identifier'><a name='81_18' title='usrString3'>length</a></span> = <span class='identifier'><a name='81_27'>Int</a></span>(<span class='identifier'><a name='81_31' href='MessageTransport.html#77_18' title='usrString1'>lengthValue</a></span>) <span class='keyword'><a name='81_44'>else</a></span> {
0082                <span class='keyword'><a name='82_12'>return</a></span> <span class='keyword'><a name='82_19'>nil</a></span>
0083            }
0084            
0085            <span class='keyword'><a name='85_8'>let</a></span> <span class='identifier'><a name='85_12' title='usrString3'>upperLimit</a></span> = <span class='identifier'><a name='85_25' href='MessageTransport.html#81_18' title='usrString1'>length</a></span> + <span class='identifier'><a name='85_34' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'><a name='85_40'>upperBound</a></span>
0086            
0087            <span class='keyword'><a name='87_8'>return</a></span> <span class='identifier'><a name='87_15' href='MessageTransport.html#69_18' title='usrString1'>range</a></span>.<span class='identifier'><a name='87_21'>upperBound</a></span>..&lt;<span class='identifier'><a name='87_34' href='MessageTransport.html#85_12' title='usrString1'>upperLimit</a></span>
0088        }
0089        
0090        <span class='builtin'><a name='90_4'>private</a></span> <span class='keyword'><a name='90_12'>func</a></span> <span class='identifier'><a name='90_17' href='#' title='usrString2' onclick='return expand(this);'>readHeaders<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#75_22"; return false;'>MessageTransport.swift:75</td><td><pre>        let headers = readHeaders(from: data, in: headersSectionRange)</pre></td></table></span></a></span>(<span class='identifier'><a name='90_29' href='MessageTransport.html#90_17' title='usrString1'>from</a></span> <span class='identifier'><a name='90_34' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='90_40'>Data</a></span>, <span class='identifier'><a name='90_46' href='MessageTransport.html#90_17' title='usrString1'>in</a></span> <span class='identifier'><a name='90_49' title='usrString2' onclick='return expand(this);'>range<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='90_56'>Range</a></span>&lt;<span class='typeidentifier'><a name='90_62'>Data</a></span>.<span class='typeidentifier'><a name='90_67'>Index</a></span>>) -> [<span class='typeidentifier'><a name='90_79'>String</a></span>: <span class='typeidentifier'><a name='90_87'>String</a></span>] {
0091            <span class='keyword'><a name='91_8'>var</a></span> <span class='identifier'><a name='91_12' title='usrString3'>headers</a></span>: [<span class='typeidentifier'><a name='91_22'>String</a></span>: <span class='typeidentifier'><a name='91_30'>String</a></span>] = [:]
0092    
0093            <span class='keyword'><a name='93_8'>var</a></span> <span class='identifier'><a name='93_12' title='usrString3'>location</a></span> = <span class='identifier'><a name='93_23' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'><a name='93_29'>lowerBound</a></span>
0094            
0095            <span class='keyword'><a name='95_8'>while</a></span> <span class='identifier'><a name='95_14' href='MessageTransport.html#93_12' title='usrString1'>location</a></span> &lt; <span class='identifier'><a name='95_25' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'><a name='95_31'>upperBound</a></span> {
0096                <span class='keyword'><a name='96_12'>let</a></span> <span class='identifier'><a name='96_16' title='usrString3'>searchRange</a></span> = <span class='identifier'><a name='96_30' href='MessageTransport.html#93_12' title='usrString1'>location</a></span>..&lt;<span class='identifier'><a name='96_41' href='MessageTransport.html#90_49' title='usrString1'>range</a></span>.<span class='identifier'><a name='96_47'>upperBound</a></span>
0097                
0098                <span class='keyword'><a name='98_12'>guard</a></span> <span class='keyword'><a name='98_18'>let</a></span> <span class='identifier'><a name='98_22' title='usrString3'>headerData</a></span> = <span class='identifier'><a name='98_35' href='MessageTransport.html#112_9' title='usrString1'>readHeader</a></span>(<span class='identifier'><a name='98_46' href='MessageTransport.html#112_9' title='usrString1'>in</a></span>: <span class='identifier'><a name='98_50' href='MessageTransport.html#90_34' title='usrString1'>data</a></span>, <span class='identifier'><a name='98_56' href='MessageTransport.html#112_9' title='usrString1'>range</a></span>: <span class='identifier'><a name='98_63' href='MessageTransport.html#96_16' title='usrString1'>searchRange</a></span>) <span class='keyword'><a name='98_76'>else</a></span> {
0099                    <span class='keyword'><a name='99_16'>break</a></span>
0100                }
0101                
0102                <span class='keyword'><a name='102_12'>let</a></span> (<span class='identifier'><a name='102_17' title='usrString3'>key</a></span>, <span class='identifier'><a name='102_22' title='usrString3'>value</a></span>, <span class='identifier'><a name='102_29' title='usrString3'>limit</a></span>) = <span class='identifier'><a name='102_38' href='MessageTransport.html#98_22' title='usrString1'>headerData</a></span>
0103                
0104                <span class='identifier'><a name='104_12' href='MessageTransport.html#91_12' title='usrString1'>headers</a></span>[<span class='identifier'><a name='104_20' href='MessageTransport.html#102_17' title='usrString1'>key</a></span>] = <span class='identifier'><a name='104_27' href='MessageTransport.html#102_22' title='usrString1'>value</a></span>
0105                
0106                <span class='identifier'><a name='106_12' href='MessageTransport.html#93_12' title='usrString1'>location</a></span> = <span class='identifier'><a name='106_23' href='MessageTransport.html#102_29' title='usrString1'>limit</a></span>
0107            }
0108            
0109            <span class='keyword'><a name='109_8'>return</a></span> <span class='identifier'><a name='109_15' href='MessageTransport.html#91_12' title='usrString1'>headers</a></span>
0110        }
0111        
0112        <span class='keyword'><a name='112_4'>func</a></span> <span class='identifier'><a name='112_9' href='#' title='usrString2' onclick='return expand(this);'>readHeader<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#98_35"; return false;'>MessageTransport.swift:98</td><td><pre>            guard let headerData = readHeader(in: data, range: searchRange) else {</pre></td></table></span></a></span>(<span class='identifier'><a name='112_20' href='MessageTransport.html#112_9' title='usrString1'>in</a></span> <span class='identifier'><a name='112_23' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='112_29'>Data</a></span>, <span class='identifier'><a name='112_35' href='#' title='usrString2' onclick='return expand(this);'>range<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#116_84"; return false;'>MessageTransport.swift:116</td><td><pre>        guard let seperatorRange = data.range(of: headerSeperator, options: [], in: range) else {</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#120_23"; return false;'>MessageTransport.swift:120</td><td><pre>        let keyRange = range.lowerBound..&lt;seperatorRange.lowerBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#121_61"; return false;'>MessageTransport.swift:121</td><td><pre>        let postSeperatorRange = seperatorRange.upperBound..&lt;range.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#124_61"; return false;'>MessageTransport.swift:124</td><td><pre>        let valueUpperBound = terminatorRange?.lowerBound ?? range.upperBound</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#138_57"; return false;'>MessageTransport.swift:138</td><td><pre>        let endOfHeader = terminatorRange?.upperBound ?? range.upperBound</pre></td></table></span></a></span>: <span class='typeidentifier'><a name='112_42'>Range</a></span>&lt;<span class='typeidentifier'><a name='112_48'>Data</a></span>.<span class='typeidentifier'><a name='112_53'>Index</a></span>>) -> (<span class='typeidentifier'><a name='112_65'>String</a></span>, <span class='typeidentifier'><a name='112_73'>String</a></span>, <span class='typeidentifier'><a name='112_81'>Data</a></span>.<span class='typeidentifier'><a name='112_86'>Index</a></span>)? {
0113            <span class='keyword'><a name='113_8'>let</a></span> <span class='identifier'><a name='113_12' title='usrString3'>seperator</a></span> = <span class='string'><a name='113_24'>"\r\n"</a></span>.<span class='identifier'><a name='113_31'>data</a></span>(<span class='identifier'><a name='113_36'>using</a></span>: .<span class='identifier'><a name='113_44'>utf8</a></span>)!
0114            <span class='keyword'><a name='114_8'>let</a></span> <span class='identifier'><a name='114_12' title='usrString3'>headerSeperator</a></span> = <span class='string'><a name='114_30'>": "</a></span>.<span class='identifier'><a name='114_35'>data</a></span>(<span class='identifier'><a name='114_40'>using</a></span>: .<span class='identifier'><a name='114_48'>utf8</a></span>)!
0115            
0116            <span class='keyword'><a name='116_8'>guard</a></span> <span class='keyword'><a name='116_14'>let</a></span> <span class='identifier'><a name='116_18' title='usrString3'>seperatorRange</a></span> = <span class='identifier'><a name='116_35' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'><a name='116_40'>range</a></span>(<span class='identifier'><a name='116_46'>of</a></span>: <span class='identifier'><a name='116_50' href='MessageTransport.html#114_12' title='usrString1'>headerSeperator</a></span>, <span class='identifier'><a name='116_67'>options</a></span>: [], <span class='identifier'><a name='116_80'>in</a></span>: <span class='identifier'><a name='116_84' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>) <span class='keyword'><a name='116_91'>else</a></span> {
0117                <span class='keyword'><a name='117_12'>return</a></span> <span class='keyword'><a name='117_19'>nil</a></span>
0118            }
0119            
0120            <span class='keyword'><a name='120_8'>let</a></span> <span class='identifier'><a name='120_12' title='usrString3'>keyRange</a></span> = <span class='identifier'><a name='120_23' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'><a name='120_29'>lowerBound</a></span>..&lt;<span class='identifier'><a name='120_42' href='MessageTransport.html#116_18' title='usrString1'>seperatorRange</a></span>.<span class='identifier'><a name='120_57'>lowerBound</a></span>
0121            <span class='keyword'><a name='121_8'>let</a></span> <span class='identifier'><a name='121_12' title='usrString3'>postSeperatorRange</a></span> = <span class='identifier'><a name='121_33' href='MessageTransport.html#116_18' title='usrString1'>seperatorRange</a></span>.<span class='identifier'><a name='121_48'>upperBound</a></span>..&lt;<span class='identifier'><a name='121_61' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'><a name='121_67'>upperBound</a></span>
0122            
0123            <span class='keyword'><a name='123_8'>let</a></span> <span class='identifier'><a name='123_12' title='usrString3'>terminatorRange</a></span> = <span class='identifier'><a name='123_30' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'><a name='123_35'>range</a></span>(<span class='identifier'><a name='123_41'>of</a></span>: <span class='identifier'><a name='123_45' href='MessageTransport.html#113_12' title='usrString1'>seperator</a></span>, <span class='identifier'><a name='123_56'>options</a></span>: [], <span class='identifier'><a name='123_69'>in</a></span>: <span class='identifier'><a name='123_73' href='MessageTransport.html#121_12' title='usrString1'>postSeperatorRange</a></span>)
0124            <span class='keyword'><a name='124_8'>let</a></span> <span class='identifier'><a name='124_12' title='usrString3'>valueUpperBound</a></span> = <span class='identifier'><a name='124_30' href='MessageTransport.html#123_12' title='usrString1'>terminatorRange</a></span>?.<span class='identifier'><a name='124_47'>lowerBound</a></span> ?? <span class='identifier'><a name='124_61' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'><a name='124_67'>upperBound</a></span>
0125            <span class='keyword'><a name='125_8'>let</a></span> <span class='identifier'><a name='125_12' title='usrString3'>valueRange</a></span> = <span class='identifier'><a name='125_25' href='MessageTransport.html#121_12' title='usrString1'>postSeperatorRange</a></span>.<span class='identifier'><a name='125_44'>lowerBound</a></span>..&lt;<span class='identifier'><a name='125_57' href='MessageTransport.html#124_12' title='usrString1'>valueUpperBound</a></span>
0126            
0127            <span class='keyword'><a name='127_8'>let</a></span> <span class='identifier'><a name='127_12' title='usrString3'>keyData</a></span> = <span class='identifier'><a name='127_22' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'><a name='127_27'>subdata</a></span>(<span class='identifier'><a name='127_35'>in</a></span>: <span class='identifier'><a name='127_39' href='MessageTransport.html#120_12' title='usrString1'>keyRange</a></span>)
0128            <span class='keyword'><a name='128_8'>let</a></span> <span class='identifier'><a name='128_12' title='usrString3'>valueData</a></span> = <span class='identifier'><a name='128_24' href='MessageTransport.html#112_23' title='usrString1'>data</a></span>.<span class='identifier'><a name='128_29'>subdata</a></span>(<span class='identifier'><a name='128_37'>in</a></span>: <span class='identifier'><a name='128_41' href='MessageTransport.html#125_12' title='usrString1'>valueRange</a></span>)
0129            
0130            <span class='keyword'><a name='130_8'>guard</a></span> <span class='keyword'><a name='130_14'>let</a></span> <span class='identifier'><a name='130_18' title='usrString3'>key</a></span> = <span class='identifier'><a name='130_24'>String</a></span>(<span class='identifier'><a name='130_31'>data</a></span>: <span class='identifier'><a name='130_37' href='MessageTransport.html#127_12' title='usrString1'>keyData</a></span>, <span class='identifier'><a name='130_46'>encoding</a></span>: .<span class='identifier'><a name='130_57'>utf8</a></span>) <span class='keyword'><a name='130_63'>else</a></span> {
0131                <span class='keyword'><a name='131_12'>return</a></span> <span class='keyword'><a name='131_19'>nil</a></span>
0132            }
0133    
0134            <span class='keyword'><a name='134_8'>guard</a></span> <span class='keyword'><a name='134_14'>let</a></span> <span class='identifier'><a name='134_18' title='usrString3'>value</a></span> = <span class='identifier'><a name='134_26'>String</a></span>(<span class='identifier'><a name='134_33'>data</a></span>: <span class='identifier'><a name='134_39' href='MessageTransport.html#128_12' title='usrString1'>valueData</a></span>, <span class='identifier'><a name='134_50'>encoding</a></span>: .<span class='identifier'><a name='134_61'>utf8</a></span>) <span class='keyword'><a name='134_67'>else</a></span> {
0135                <span class='keyword'><a name='135_12'>return</a></span> <span class='keyword'><a name='135_19'>nil</a></span>
0136            }
0137            
0138            <span class='keyword'><a name='138_8'>let</a></span> <span class='identifier'><a name='138_12' title='usrString3'>endOfHeader</a></span> = <span class='identifier'><a name='138_26' href='MessageTransport.html#123_12' title='usrString1'>terminatorRange</a></span>?.<span class='identifier'><a name='138_43'>upperBound</a></span> ?? <span class='identifier'><a name='138_57' href='MessageTransport.html#112_35' title='usrString1'>range</a></span>.<span class='identifier'><a name='138_63'>upperBound</a></span>
0139            
0140            <span class='keyword'><a name='140_8'>return</a></span> (<span class='identifier'><a name='140_16' href='MessageTransport.html#130_18' title='usrString1'>key</a></span>, <span class='identifier'><a name='140_21' href='MessageTransport.html#134_18' title='usrString1'>value</a></span>, <span class='identifier'><a name='140_28' href='MessageTransport.html#138_12' title='usrString1'>endOfHeader</a></span>)
0141        }
0142        
0143        <span class='builtin'><a name='143_4'>public</a></span> <span class='keyword'><a name='143_11'>static</a></span> <span class='keyword'><a name='143_18'>func</a></span> <span class='identifier'><a name='143_23' href='#' title='usrString2' onclick='return expand(this);'>createMessage<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="MessageTransport.html#157_43"; return false;'>MessageTransport.swift:157</td><td><pre>        let messageData = MessageTransport.createMessage(with: data)</pre></td></table></span></a></span>(<span class='identifier'><a name='143_37' href='MessageTransport.html#143_23' title='usrString1'>with</a></span> <span class='identifier'><a name='143_42' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='143_48'>Data</a></span>) -> <span class='typeidentifier'><a name='143_57'>Data</a></span> {
0144            <span class='keyword'><a name='144_8'>let</a></span> <span class='identifier'><a name='144_12' title='usrString3'>length</a></span> = <span class='identifier'><a name='144_21' href='MessageTransport.html#143_42' title='usrString1'>data</a></span>.<span class='identifier'><a name='144_26'>count</a></span>
0145    
0146            <span class='keyword'><a name='146_8'>let</a></span> <span class='identifier'><a name='146_12' title='usrString3'>header</a></span> = <span class='string'><a name='146_21'>"Content-Length: </a></span>\<span class='string_interpolation_anchor'><a name='146_39'>(</a></span><span class='identifier'><a name='146_40' href='MessageTransport.html#144_12' title='usrString1'>length</a></span><span class='string_interpolation_anchor'><a name='146_46'>)</a></span><span class='string'><a name='146_47'>\r\n\r\n"</a></span>
0147            <span class='keyword'><a name='147_8'>guard</a></span> <span class='keyword'><a name='147_14'>let</a></span> <span class='identifier'><a name='147_18' title='usrString3'>headerData</a></span> = <span class='identifier'><a name='147_31' href='MessageTransport.html#146_12' title='usrString1'>header</a></span>.<span class='identifier'><a name='147_38'>data</a></span>(<span class='identifier'><a name='147_43'>using</a></span>: .<span class='identifier'><a name='147_51'>utf8</a></span>) <span class='keyword'><a name='147_57'>else</a></span> {
0148                <span class='identifier'><a name='148_12'>fatalError</a></span>()
0149            }
0150    
0151            <span class='keyword'><a name='151_8'>return</a></span> <span class='identifier'><a name='151_15' href='MessageTransport.html#147_18' title='usrString1'>headerData</a></span> + <span class='identifier'><a name='151_28' href='MessageTransport.html#143_42' title='usrString1'>data</a></span>
0152        }
0153    }
0154    
0155    <span class='keyword'><a name='155_0'>extension</a></span> <span class='typeidentifier'><a name='155_10'>MessageTransport</a></span>: <span class='typeidentifier'><a name='155_28'>DataTransport</a></span> {
0156        <span class='builtin'><a name='156_4'>public</a></span> <span class='keyword'><a name='156_11'>func</a></span> <span class='identifier'><a name='156_16' href='#' title='usrString2' onclick='return expand(this);'>write<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#77_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:77</td><td><pre>            self.messageTransport.write(jsonData)</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="ProtocolTransport.html#115_34"; event.stopPropagation(); return false;'>ProtocolTransport.swift:115</td><td><pre>            self.messageTransport.write(jsonData)</pre></td></table></span></a></span>(<span class='keyword'><a name='156_22'>_</a></span> <span class='identifier'><a name='156_24' title='usrString2' onclick='return expand(this);'>data<span class='references'><table></table></span></a></span>: <span class='typeidentifier'><a name='156_30'>Data</a></span>) {
0157            <span class='keyword'><a name='157_8'>let</a></span> <span class='identifier'><a name='157_12' title='usrString3'>messageData</a></span> = <span class='identifier'><a name='157_26' href='MessageTransport.html#11_13' title='usrString1'>MessageTransport</a></span>.<span class='identifier'><a name='157_43' href='MessageTransport.html#143_23' title='usrString1'>createMessage</a></span>(<span class='identifier'><a name='157_57' href='MessageTransport.html#143_23' title='usrString1'>with</a></span>: <span class='identifier'><a name='157_63' href='MessageTransport.html#156_24' title='usrString1'>data</a></span>)
0158    
0159            <span class='identifier'><a name='159_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='159_22' href='DataTransport.html#14_9' title='usrString1'>write</a></span>(<span class='identifier'><a name='159_28' href='MessageTransport.html#157_12' title='usrString1'>messageData</a></span>)
0160        }
0161    
0162        <span class='builtin'><a name='162_4'>public</a></span> <span class='keyword'><a name='162_11'>func</a></span> <span class='identifier'><a name='162_16' title='usrString2' onclick='return expand(this);'>setReaderHandler<span class='references'><table></table></span></a></span>(<span class='keyword'><a name='162_33'>_</a></span> <span class='identifier'><a name='162_35' title='usrString2' onclick='return expand(this);'>handler<span class='references'><table></table></span></a></span>: <span class='builtin'><a name='162_44'>@escaping</a></span> <span class='typeidentifier'><a name='162_54'>DataTransport</a></span>.<span class='typeidentifier'><a name='162_68'>ReadHandler</a></span>) {
0163            <span class='keyword'><a name='163_8'>self</a></span>.<span class='identifier'><a name='163_13' href='MessageTransport.html#13_8' title='usrString1'>dataHandler</a></span> = <span class='identifier'><a name='163_27' href='MessageTransport.html#162_35' title='usrString1'>handler</a></span>
0164        }
0165    
0166        <span class='builtin'><a name='166_4'>public</a></span> <span class='keyword'><a name='166_11'>func</a></span> <span class='identifier'><a name='166_16' title='usrString2' onclick='return expand(this);'>close<span class='references'><table></table></span></a></span>() {
0167            <span class='identifier'><a name='167_8' href='MessageTransport.html#12_16' title='usrString1'>dataTransport</a></span>.<span class='identifier'><a name='167_22' href='DataTransport.html#17_9' title='usrString1'>close</a></span>()
0168        }
0169    }
0170    