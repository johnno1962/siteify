<html><head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="siteify.css">
<script>

var lastlink;

function expand(a) {
    if ( a.children[0].style.display != "block" ) {
        if ( lastlink )
            lastlink.style.display = "none";
        a.children[0].style.display = "block";
        lastlink = a.children[0];
    }
    else {
        a.children[0].style.display = "none";
        lastlink = null;
    }
    return false;
}

</script></head><body><pre>
0001    <span class='comment'><a name='1_0' title='usrString0'>//
0002    </a></span><span class='comment'><a name='2_0' title='usrString0'>//  MessageTransportTests.swift
0003    </a></span><span class='comment'><a name='3_0' title='usrString0'>//  SwiftLSPClientTests
0004    </a></span><span class='comment'><a name='4_0' title='usrString0'>//
0005    </a></span><span class='comment'><a name='5_0' title='usrString0'>//  Created by Matt Massicotte on 2018-10-15.
0006    </a></span><span class='comment'><a name='6_0' title='usrString0'>//  Copyright Â© 2018 Chime Systems. All rights reserved.
0007    </a></span><span class='comment'><a name='7_0' title='usrString0'>//
0008    </a></span>
0009    <span class='keyword'><a name='9_0' title='usrString0'>import</a></span> <span class='identifier'><a name='9_7'>XCTest</a></span>
0010    <span class='builtin'><a name='10_0' title='usrString0'>@testable</a></span> <span class='keyword'><a name='10_10' title='usrString0'>import</a></span> <span class='identifier'><a name='10_17'>SwiftLSPClient</a></span>
0011    
0012    <span class='keyword'><a name='12_0' title='usrString0'>class</a></span> <span class='identifier'><a name='12_6'>MessageTransportTests</a></span>: <span class='typeidentifier'><a name='12_29' title='usrString0'>XCTestCase</a></span> {
0013        <span class='keyword'><a name='13_4' title='usrString0'>func</a></span> <span class='identifier'><a name='13_9'>writeMessageAndReadResult</a></span>(<span class='keyword'><a name='13_35' href='MessageTransportTests.html#13_9' title='usrString1'>_</a></span> <span class='identifier'><a name='13_37'>message</a></span>: <span class='typeidentifier'><a name='13_46' title='usrString0'>String</a></span>) -> <span class='typeidentifier'><a name='13_57' title='usrString0'>Data</a></span>? {
0014            <span class='keyword'><a name='14_8' title='usrString0'>let</a></span> <span class='identifier'><a name='14_12'>results</a></span> = <span class='identifier'><a name='14_22'>writeMessagesAndReadResult</a></span>([<span class='identifier'><a name='14_50'>message</a></span>])
0015            
0016            <span class='keyword'><a name='16_8' title='usrString0'>guard</a></span> <span class='identifier'><a name='16_14'>results</a></span>.<span class='identifier'><a name='16_22'>count</a></span> == <span class='number'><a name='16_31' title='usrString0'>1</a></span> <span class='keyword'><a name='16_33' title='usrString0'>else</a></span> {
0017                <span class='keyword'><a name='17_12' title='usrString0'>return</a></span> <span class='keyword'><a name='17_19' title='usrString0'>nil</a></span>
0018            }
0019            
0020            <span class='keyword'><a name='20_8' title='usrString0'>return</a></span> <span class='identifier'><a name='20_15'>results</a></span>[<span class='number'><a name='20_23' title='usrString0'>0</a></span>]
0021        }
0022        
0023        <span class='keyword'><a name='23_4' title='usrString0'>func</a></span> <span class='identifier'><a name='23_9'>writeMessagesAndReadResult</a></span>(<span class='keyword'><a name='23_36' href='MessageTransportTests.html#23_9' title='usrString1'>_</a></span> <span class='identifier'><a name='23_38'>messages</a></span>: [<span class='typeidentifier'><a name='23_49' title='usrString0'>String</a></span>]) -> [<span class='typeidentifier'><a name='23_62' title='usrString0'>Data</a></span>] {
0024            <span class='keyword'><a name='24_8' title='usrString0'>let</a></span> <span class='identifier'><a name='24_12'>dataTransport</a></span> = <span class='identifier'><a name='24_28'>MockDataTransport</a></span>()
0025            
0026            <span class='keyword'><a name='26_8' title='usrString0'>let</a></span> <span class='identifier'><a name='26_12'>transport</a></span> = <span class='identifier'><a name='26_24'>MessageTransport</a></span>(<span class='identifier'><a name='26_41'>dataTransport</a></span>: <span class='identifier'><a name='26_56'>dataTransport</a></span>)
0027            
0028            <span class='keyword'><a name='28_8' title='usrString0'>var</a></span> <span class='identifier'><a name='28_12'>receivedData</a></span>: [<span class='typeidentifier'><a name='28_27' title='usrString0'>Data</a></span>] = []
0029            
0030            <span class='identifier'><a name='30_8'>transport</a></span>.<span class='identifier'><a name='30_18'>dataHandler</a></span> = { (<span class='identifier'><a name='30_35'>data</a></span>) <span class='keyword'><a name='30_41' title='usrString0'>in</a></span>
0031                <span class='identifier'><a name='31_12'>receivedData</a></span>.<span class='identifier'><a name='31_25'>append</a></span>(<span class='identifier'><a name='31_32'>data</a></span>)
0032            }
0033            
0034            <span class='keyword'><a name='34_8' title='usrString0'>for</a></span> <span class='identifier'><a name='34_12'>message</a></span> <span class='keyword'><a name='34_20' title='usrString0'>in</a></span> <span class='identifier'><a name='34_23'>messages</a></span> {
0035                <span class='identifier'><a name='35_12'>dataTransport</a></span>.<span class='identifier'><a name='35_26'>mockRead</a></span>(<span class='identifier'><a name='35_35'>message</a></span>)
0036            }
0037            
0038            <span class='keyword'><a name='38_8' title='usrString0'>return</a></span> <span class='identifier'><a name='38_15'>receivedData</a></span>
0039        }
0040        
0041        <span class='keyword'><a name='41_4' title='usrString0'>func</a></span> <span class='identifier'><a name='41_9'>testBasicMessageDecode</a></span>() {
0042            <span class='keyword'><a name='42_8' title='usrString0'>let</a></span> <span class='identifier'><a name='42_12'>content</a></span> = <span class='string'><a name='42_22' title='usrString0'>"{\"jsonrpc\":\"2.0\",\"params\":\"Something\"}"</a></span>
0043            <span class='keyword'><a name='43_8' title='usrString0'>let</a></span> <span class='identifier'><a name='43_12'>message</a></span> = <span class='string'><a name='43_22' title='usrString0'>"Content-Length: 38\r\n\r\n</a></span>\<span class='string_interpolation_anchor'><a name='43_50' title='usrString0'>(</a></span><span class='identifier'><a name='43_51'>content</a></span><span class='string_interpolation_anchor'><a name='43_58' title='usrString0'>)</a></span><span class='string'><a name='43_59' title='usrString0'>"</a></span>
0044            
0045            <span class='keyword'><a name='45_8' title='usrString0'>let</a></span> <span class='identifier'><a name='45_12'>data</a></span> = <span class='identifier'><a name='45_19'>writeMessageAndReadResult</a></span>(<span class='identifier'><a name='45_45'>message</a></span>)
0046            
0047            <span class='identifier'><a name='47_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='47_23'>data</a></span>, <span class='identifier'><a name='47_29'>content</a></span>.<span class='identifier'><a name='47_37'>data</a></span>(<span class='identifier'><a name='47_42'>using</a></span>: .<span class='identifier'><a name='47_50'>utf8</a></span>)!)
0048        }
0049        
0050        <span class='keyword'><a name='50_4' title='usrString0'>func</a></span> <span class='identifier'><a name='50_9'>testMultiHeaderMessage</a></span>() {
0051            <span class='keyword'><a name='51_8' title='usrString0'>let</a></span> <span class='identifier'><a name='51_12'>content</a></span> = <span class='string'><a name='51_22' title='usrString0'>"{\"jsonrpc\":\"2.0\",\"params\":\"Something\"}"</a></span>
0052            <span class='keyword'><a name='52_8' title='usrString0'>let</a></span> <span class='identifier'><a name='52_12'>header1</a></span> = <span class='string'><a name='52_22' title='usrString0'>"Content-Length: 38\r\n"</a></span>
0053            <span class='keyword'><a name='53_8' title='usrString0'>let</a></span> <span class='identifier'><a name='53_12'>header2</a></span> = <span class='string'><a name='53_22' title='usrString0'>"Another-Header: Something\r\n"</a></span>
0054            <span class='keyword'><a name='54_8' title='usrString0'>let</a></span> <span class='identifier'><a name='54_12'>header3</a></span> = <span class='string'><a name='54_22' title='usrString0'>"And-Another: third\r\n"</a></span>
0055            <span class='keyword'><a name='55_8' title='usrString0'>let</a></span> <span class='identifier'><a name='55_12'>message</a></span> = <span class='identifier'><a name='55_22'>header1</a></span> + <span class='identifier'><a name='55_32'>header2</a></span> + <span class='identifier'><a name='55_42'>header3</a></span> + <span class='string'><a name='55_52' title='usrString0'>"\r\n"</a></span> + <span class='identifier'><a name='55_61'>content</a></span>
0056            
0057            <span class='keyword'><a name='57_8' title='usrString0'>let</a></span> <span class='identifier'><a name='57_12'>data</a></span> = <span class='identifier'><a name='57_19'>writeMessageAndReadResult</a></span>(<span class='identifier'><a name='57_45'>message</a></span>)
0058            
0059            <span class='identifier'><a name='59_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='59_23'>data</a></span>, <span class='identifier'><a name='59_29'>content</a></span>.<span class='identifier'><a name='59_37'>data</a></span>(<span class='identifier'><a name='59_42'>using</a></span>: .<span class='identifier'><a name='59_50'>utf8</a></span>)!)
0060        }
0061        
0062        <span class='keyword'><a name='62_4' title='usrString0'>func</a></span> <span class='identifier'><a name='62_9'>testMultiReadMessage</a></span>() {
0063            <span class='keyword'><a name='63_8' title='usrString0'>let</a></span> <span class='identifier'><a name='63_12'>messages</a></span> = [
0064                <span class='string'><a name='64_12' title='usrString0'>"Content-Le"</a></span>,
0065                <span class='string'><a name='65_12' title='usrString0'>"ngth: 30\r\n"</a></span>,
0066                <span class='string'><a name='66_12' title='usrString0'>"Header2: h"</a></span>,
0067                <span class='string'><a name='67_12' title='usrString0'>"llo\r\n\r\n"</a></span>,
0068                <span class='string'><a name='68_12' title='usrString0'>"abcdefghij"</a></span>,
0069                <span class='string'><a name='69_12' title='usrString0'>"klmnopqurs"</a></span>,
0070                <span class='string'><a name='70_12' title='usrString0'>"tuvwxyz123"</a></span>
0071            ]
0072            
0073            <span class='keyword'><a name='73_8' title='usrString0'>let</a></span> <span class='identifier'><a name='73_12'>content</a></span> = <span class='string'><a name='73_22' title='usrString0'>"abcdefghijklmnopqurstuvwxyz123"</a></span>
0074    
0075            <span class='keyword'><a name='75_8' title='usrString0'>let</a></span> <span class='identifier'><a name='75_12'>results</a></span> = <span class='identifier'><a name='75_22'>writeMessagesAndReadResult</a></span>(<span class='identifier'><a name='75_49'>messages</a></span>)
0076            
0077            <span class='keyword'><a name='77_8' title='usrString0'>guard</a></span> <span class='identifier'><a name='77_14'>results</a></span>.<span class='identifier'><a name='77_22'>count</a></span> == <span class='number'><a name='77_31' title='usrString0'>1</a></span> <span class='keyword'><a name='77_33' title='usrString0'>else</a></span> {
0078                <span class='identifier'><a name='78_12'>XCTFail</a></span>()
0079                <span class='keyword'><a name='79_12' title='usrString0'>return</a></span>
0080            }
0081            
0082            <span class='identifier'><a name='82_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='82_23'>results</a></span>[<span class='number'><a name='82_31' title='usrString0'>0</a></span>], <span class='identifier'><a name='82_35'>content</a></span>.<span class='identifier'><a name='82_43'>data</a></span>(<span class='identifier'><a name='82_48'>using</a></span>: .<span class='identifier'><a name='82_56'>utf8</a></span>)!)
0083        }
0084        
0085        <span class='keyword'><a name='85_4' title='usrString0'>func</a></span> <span class='identifier'><a name='85_9'>testMultiReadMessageWithSecondMessageInARead</a></span>() {
0086            <span class='keyword'><a name='86_8' title='usrString0'>let</a></span> <span class='identifier'><a name='86_12'>messages</a></span> = [
0087                <span class='string'><a name='87_12' title='usrString0'>"Content-Length: 6\r\n"</a></span>,
0088                <span class='string'><a name='88_12' title='usrString0'>"Another-Header: hello\r\n\r\n"</a></span>,
0089                <span class='string'><a name='89_12' title='usrString0'>"abcdefContent-Length: 10\r\n"</a></span>,
0090                <span class='string'><a name='90_12' title='usrString0'>"\r\nabcdefghij"</a></span>,
0091            ]
0092            
0093            <span class='keyword'><a name='93_8' title='usrString0'>let</a></span> <span class='identifier'><a name='93_12'>results</a></span> = <span class='identifier'><a name='93_22'>writeMessagesAndReadResult</a></span>(<span class='identifier'><a name='93_49'>messages</a></span>)
0094            
0095            <span class='keyword'><a name='95_8' title='usrString0'>if</a></span> <span class='identifier'><a name='95_11'>results</a></span>.<span class='identifier'><a name='95_19'>count</a></span> != <span class='number'><a name='95_28' title='usrString0'>2</a></span> {
0096                <span class='identifier'><a name='96_12'>XCTFail</a></span>()
0097                <span class='keyword'><a name='97_12' title='usrString0'>return</a></span>
0098            }
0099            
0100            <span class='identifier'><a name='100_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='100_23'>results</a></span>[<span class='number'><a name='100_31' title='usrString0'>0</a></span>], <span class='string'><a name='100_35' title='usrString0'>"abcdef"</a></span>.<span class='identifier'><a name='100_44'>data</a></span>(<span class='identifier'><a name='100_49'>using</a></span>: .<span class='identifier'><a name='100_57'>utf8</a></span>)!)
0101            <span class='identifier'><a name='101_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='101_23'>results</a></span>[<span class='number'><a name='101_31' title='usrString0'>1</a></span>], <span class='string'><a name='101_35' title='usrString0'>"abcdefghij"</a></span>.<span class='identifier'><a name='101_48'>data</a></span>(<span class='identifier'><a name='101_53'>using</a></span>: .<span class='identifier'><a name='101_61'>utf8</a></span>)!)
0102        }
0103        
0104        <span class='keyword'><a name='104_4' title='usrString0'>func</a></span> <span class='identifier'><a name='104_9'>testDecodeMessagePerformance</a></span>() {
0105            <span class='keyword'><a name='105_8' title='usrString0'>let</a></span> <span class='identifier'><a name='105_12'>dataTransport</a></span> = <span class='identifier'><a name='105_28'>MockDataTransport</a></span>()
0106            
0107            <span class='keyword'><a name='107_8' title='usrString0'>let</a></span> <span class='identifier'><a name='107_12'>transport</a></span> = <span class='identifier'><a name='107_24'>MessageTransport</a></span>(<span class='identifier'><a name='107_41'>dataTransport</a></span>: <span class='identifier'><a name='107_56'>dataTransport</a></span>)
0108            
0109            <span class='keyword'><a name='109_8' title='usrString0'>var</a></span> <span class='identifier'><a name='109_12'>receiveCount</a></span>: <span class='typeidentifier'><a name='109_26' title='usrString0'>Int</a></span> = <span class='number'><a name='109_32' title='usrString0'>0</a></span>
0110            
0111            <span class='identifier'><a name='111_8'>transport</a></span>.<span class='identifier'><a name='111_18'>dataHandler</a></span> = { (<span class='identifier'><a name='111_35'>data</a></span>) <span class='keyword'><a name='111_41' title='usrString0'>in</a></span>
0112                <span class='identifier'><a name='112_12'>receiveCount</a></span> += <span class='number'><a name='112_28' title='usrString0'>1</a></span>
0113            }
0114            
0115            <span class='keyword'><a name='115_8' title='usrString0'>let</a></span> <span class='identifier'><a name='115_12'>content</a></span> = <span class='string'><a name='115_22' title='usrString0'>"{\"jsonrpc\":\"2.0\",\"params\":\"Something\"}"</a></span>
0116            <span class='keyword'><a name='116_8' title='usrString0'>let</a></span> <span class='identifier'><a name='116_12'>message</a></span> = <span class='string'><a name='116_22' title='usrString0'>"Content-Length: 38\r\n\r\n</a></span>\<span class='string_interpolation_anchor'><a name='116_50' title='usrString0'>(</a></span><span class='identifier'><a name='116_51'>content</a></span><span class='string_interpolation_anchor'><a name='116_58' title='usrString0'>)</a></span><span class='string'><a name='116_59' title='usrString0'>"</a></span>
0117            
0118            <span class='identifier'><a name='118_8'>measure</a></span> {
0119                <span class='keyword'><a name='119_12' title='usrString0'>for</a></span> <span class='keyword'><a name='119_16' title='usrString0'>_</a></span> <span class='keyword'><a name='119_18' title='usrString0'>in</a></span> <span class='number'><a name='119_21' title='usrString0'>0</a></span>..&lt;<span class='number'><a name='119_25' title='usrString0'>1000</a></span> {
0120                    <span class='identifier'><a name='120_16'>dataTransport</a></span>.<span class='identifier'><a name='120_30'>mockRead</a></span>(<span class='identifier'><a name='120_39'>message</a></span>)
0121                }
0122            }
0123            
0124            <span class='identifier'><a name='124_8'>XCTAssert</a></span>(<span class='identifier'><a name='124_18'>receiveCount</a></span> >= <span class='number'><a name='124_34' title='usrString0'>1000</a></span>)
0125        }
0126    
0127        <span class='keyword'><a name='127_4' title='usrString0'>func</a></span> <span class='identifier'><a name='127_9'>testTwoFullMessagesInOneRead</a></span>() {
0128            <span class='keyword'><a name='128_8' title='usrString0'>let</a></span> <span class='identifier'><a name='128_12'>messages</a></span> = [
0129                <span class='string'><a name='129_12' title='usrString0'>"Content-Length: 6\r\n\r\nabcdefContent-Length: 10\r\n\r\nabcdefghij"</a></span>
0130            ]
0131    
0132            <span class='keyword'><a name='132_8' title='usrString0'>let</a></span> <span class='identifier'><a name='132_12'>results</a></span> = <span class='identifier'><a name='132_22'>writeMessagesAndReadResult</a></span>(<span class='identifier'><a name='132_49'>messages</a></span>)
0133    
0134            <span class='keyword'><a name='134_8' title='usrString0'>if</a></span> <span class='identifier'><a name='134_11'>results</a></span>.<span class='identifier'><a name='134_19'>count</a></span> != <span class='number'><a name='134_28' title='usrString0'>2</a></span> {
0135                <span class='identifier'><a name='135_12'>XCTFail</a></span>()
0136                <span class='keyword'><a name='136_12' title='usrString0'>return</a></span>
0137            }
0138    
0139            <span class='identifier'><a name='139_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='139_23'>results</a></span>[<span class='number'><a name='139_31' title='usrString0'>0</a></span>], <span class='string'><a name='139_35' title='usrString0'>"abcdef"</a></span>.<span class='identifier'><a name='139_44'>data</a></span>(<span class='identifier'><a name='139_49'>using</a></span>: .<span class='identifier'><a name='139_57'>utf8</a></span>)!)
0140            <span class='identifier'><a name='140_8'>XCTAssertEqual</a></span>(<span class='identifier'><a name='140_23'>results</a></span>[<span class='number'><a name='140_31' title='usrString0'>1</a></span>], <span class='string'><a name='140_35' title='usrString0'>"abcdefghij"</a></span>.<span class='identifier'><a name='140_48'>data</a></span>(<span class='identifier'><a name='140_53'>using</a></span>: .<span class='identifier'><a name='140_61'>utf8</a></span>)!)
0141        }
0142    }
0143    