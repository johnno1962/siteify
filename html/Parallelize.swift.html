<html><head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="siteify.css">
<script>

var lastlink;

function expand(a) {
    if ( a.children[0].style.display != "block" ) {
        if ( lastlink )
            lastlink.style.display = "none";
        a.children[0].style.display = "block";
        lastlink = a.children[0];
    }
    else {
        a.children[0].style.display = "none";
        lastlink = null;
    }
    return false;
}

</script></head><body><h3>siteify/Parallelize.swift</h3><pre><span class=linenum>0001</span>    <span class='comment'>//
<span class=linenum>0002</span>    </span><span class='comment'>//  Parallelise.swift
<span class=linenum>0003</span>    </span><span class='comment'>//  siteify
<span class=linenum>0004</span>    </span><span class='comment'>//
<span class=linenum>0005</span>    </span><span class='comment'>//  Created by John Holdsworth on 30/10/2019.
<span class=linenum>0006</span>    </span><span class='comment'>//  Copyright Â© 2019 John Holdsworth. All rights reserved.
<span class=linenum>0007</span>    </span><span class='comment'>//
<span class=linenum>0008</span>    </span><span class='comment'>//  $Id: //depot/siteify/siteify/Parallelize.swift#4 $
<span class=linenum>0009</span>    </span><span class='comment'>//
<span class=linenum>0010</span>    </span><span class='comment'>//  Repo: </span><span class='url'><a href='https://github.com/johnno1962/siteify'>https://github.com/johnno1962/siteify</a></span><span class='comment'>
<span class=linenum>0011</span>    </span><span class='comment'>//
<span class=linenum>0012</span>    </span>
<span class=linenum>0013</span>    <span class='keyword'>import</span> <span class='identifier'>Foundation</span>
<span class=linenum>0014</span>    
<span class=linenum>0015</span>    <span class='keyword'>extension</span> <span class='typeidentifier'>Sequence</span> {
<span class=linenum>0016</span>    
<span class=linenum>0017</span>        <span class='builtin'>@discardableResult</span>
<span class=linenum>0018</span>        <span class='keyword'>func</span> <span class='identifier'><a name='18_9' href='#' title='usrString2' onclick='return expand(this);'>concurrentMap<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="Siteify.swift.html#142_13"; event.stopPropagation(); return false;'>Siteify.swift:142</td><td><pre>            .concurrentMap(maxConcurrency: 8) { (path, completion: (String?) -> Void) in</pre></td><tr><td style='text-decoration: underline;' onclick='document.location.href="Siteify.swift.html#219_18"; event.stopPropagation(); return false;'>Siteify.swift:219</td><td><pre>                }.concurrentMap(maxConcurrency: 1</pre></td></table></span></a></span>&lt;<span class='identifier'><a name='18_23' title='usrString3'>Output</a></span>>(<span class='identifier'><a name='18_31' href='#' title='usrString2' onclick='return expand(this);'>maxConcurrency<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="Parallelize.swift.html#37_53"; return false;'>Parallelize.swift:37</td><td><pre>            let semaphore = DispatchSemaphore(value: maxConcurrency)</pre></td></table></span></a></span>: <span class='typeidentifier'>Int</span> = <span class='number'>4</span>,
<span class=linenum>0019</span>                                   <span class='identifier'><a name='19_31' href='#' title='usrString2' onclick='return expand(this);'>queueName<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="Parallelize.swift.html#35_55"; return false;'>Parallelize.swift:35</td><td><pre>            let concurrentQueue = DispatchQueue(label: queueName, qos: priority,</pre></td></table></span></a></span>: <span class='typeidentifier'>String</span> = <span class='string'>"concurrentMap"</span>,
<span class=linenum>0020</span>                                   <span class='identifier'><a name='20_31' href='#' title='usrString2' onclick='return expand(this);'>priority<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="Parallelize.swift.html#35_71"; return false;'>Parallelize.swift:35</td><td><pre>            let concurrentQueue = DispatchQueue(label: queueName, qos: priority,</pre></td></table></span></a></span>: <span class='typeidentifier'>DispatchQoS</span> = .<span class='identifier'>default</span>,
<span class=linenum>0021</span>                                   <span class='identifier'><a name='21_31' href='#' title='usrString2' onclick='return expand(this);'>worker<span class='references'><table><tr><td style='text-decoration: underline;' onclick='document.location.href="Parallelize.swift.html#45_20"; return false;'>Parallelize.swift:45</td><td><pre>                    worker(input[index], { result in</pre></td></table></span></a></span>: <span class='builtin'>@escaping</span> (<span class='typeidentifier'>Element</span>,
<span class=linenum>0022</span>                                <span class='builtin'>@escaping</span> (<span class='typeidentifier'><a name='22_39' href='Parallelize.swift.html#18_23' title='usrString1'>Output</a></span>) -> <span class='typeidentifier'>Void</span>) -> <span class='typeidentifier'>Void</span>) -> [<span class='typeidentifier'><a name='22_69' href='Parallelize.swift.html#18_23' title='usrString1'>Output</a></span>] {
<span class=linenum>0023</span>            <span class='keyword'>let</span> <span class='identifier'><a name='23_12' title='usrString3'>input</a></span> = <span class='identifier'>Array</span>(<span class='keyword'>self</span>)
<span class=linenum>0024</span>            <span class='keyword'>var</span> <span class='identifier'><a name='24_12' title='usrString3'>output</a></span> = <span class='identifier'>Array</span>&lt;<span class='typeidentifier'><a name='24_27' href='Parallelize.swift.html#18_23' title='usrString1'>Output</a></span>>(<span class='identifier'>unsafeUninitializedCapacity</span>: <span class='identifier'><a name='24_64' href='Parallelize.swift.html#23_12' title='usrString1'>input</a></span>.<span class='identifier'>count</span>,
<span class=linenum>0025</span>                                       <span class='identifier'>initializingWith</span>: {
<span class=linenum>0026</span>                                        (<span class='identifier'><a name='26_37' title='usrString3'>buffer</a></span>, <span class='identifier'><a name='26_45' title='usrString3'>initializedCount</a></span>) <span class='keyword'>in</span>
<span class=linenum>0027</span>                                        <span class='keyword'>let</span> <span class='identifier'><a name='27_40' title='usrString3'>stride</a></span> = <span class='identifier'>MemoryLayout</span>&lt;<span class='typeidentifier'><a name='27_62' href='Parallelize.swift.html#18_23' title='usrString1'>Output</a></span>>.<span class='identifier'>stride</span>
<span class=linenum>0028</span>                                        <span class='identifier'>memset</span>(<span class='identifier'><a name='28_43' href='Parallelize.swift.html#26_37' title='usrString1'>buffer</a></span>.<span class='identifier'>baseAddress</span>, <span class='number'>0</span>,
<span class=linenum>0029</span>                                               <span class='identifier'><a name='29_43' href='Parallelize.swift.html#27_40' title='usrString1'>stride</a></span> * <span class='identifier'><a name='29_52' href='Parallelize.swift.html#23_12' title='usrString1'>input</a></span>.<span class='identifier'>count</span>)
<span class=linenum>0030</span>                                        <span class='identifier'><a name='30_36' href='Parallelize.swift.html#26_45' title='usrString1'>initializedCount</a></span> = <span class='identifier'><a name='30_55' href='Parallelize.swift.html#23_12' title='usrString1'>input</a></span>.<span class='identifier'>count</span>})
<span class=linenum>0031</span>    
<span class=linenum>0032</span>            <span class='identifier'><a name='32_8' href='Parallelize.swift.html#24_12' title='usrString1'>output</a></span>.<span class='identifier'>withUnsafeMutableBufferPointer</span> {
<span class=linenum>0033</span>                <span class='identifier'><a name='33_12' title='usrString3'>buffer</a></span> <span class='keyword'>in</span>
<span class=linenum>0034</span>                <span class='keyword'>let</span> <span class='identifier'><a name='34_16' title='usrString3'>buffro</a></span> = <span class='identifier'><a name='34_25' href='Parallelize.swift.html#33_12' title='usrString1'>buffer</a></span>
<span class=linenum>0035</span>                <span class='keyword'>let</span> <span class='identifier'><a name='35_16' title='usrString3'>concurrentQueue</a></span> = <span class='identifier'>DispatchQueue</span>(<span class='identifier'>label</span>: <span class='identifier'><a name='35_55' href='Parallelize.swift.html#19_31' title='usrString1'>queueName</a></span>, <span class='identifier'>qos</span>: <span class='identifier'><a name='35_71' href='Parallelize.swift.html#20_31' title='usrString1'>priority</a></span>,
<span class=linenum>0036</span>                                                    <span class='identifier'>attributes</span>: .<span class='identifier'>concurrent</span>)
<span class=linenum>0037</span>                <span class='keyword'>let</span> <span class='identifier'><a name='37_16' title='usrString3'>semaphore</a></span> = <span class='identifier'>DispatchSemaphore</span>(<span class='identifier'>value</span>: <span class='identifier'><a name='37_53' href='Parallelize.swift.html#18_31' title='usrString1'>maxConcurrency</a></span>)
<span class=linenum>0038</span>                <span class='keyword'>let</span> <span class='identifier'><a name='38_16' title='usrString3'>threadGroup</a></span> = <span class='identifier'>DispatchGroup</span>()
<span class=linenum>0039</span>    
<span class=linenum>0040</span>                <span class='keyword'>for</span> <span class='identifier'><a name='40_16' title='usrString3'>index</a></span> <span class='keyword'>in</span> <span class='number'>0</span>..&lt;<span class='identifier'><a name='40_29' href='Parallelize.swift.html#23_12' title='usrString1'>input</a></span>.<span class='identifier'>count</span> {
<span class=linenum>0041</span>                    <span class='identifier'><a name='41_16' href='Parallelize.swift.html#38_16' title='usrString1'>threadGroup</a></span>.<span class='identifier'>enter</span>()
<span class=linenum>0042</span>                    <span class='identifier'><a name='42_16' href='Parallelize.swift.html#37_16' title='usrString1'>semaphore</a></span>.<span class='identifier'>wait</span>()
<span class=linenum>0043</span>    
<span class=linenum>0044</span>                    <span class='identifier'><a name='44_16' href='Parallelize.swift.html#35_16' title='usrString1'>concurrentQueue</a></span>.<span class='identifier'>async</span> {
<span class=linenum>0045</span>                        <span class='identifier'><a name='45_20' href='Parallelize.swift.html#21_31' title='usrString1'>worker</a></span>(<span class='identifier'><a name='45_27' href='Parallelize.swift.html#23_12' title='usrString1'>input</a></span>[<span class='identifier'><a name='45_33' href='Parallelize.swift.html#40_16' title='usrString1'>index</a></span>], { <span class='identifier'><a name='45_43' title='usrString3'>result</a></span> <span class='keyword'>in</span>
<span class=linenum>0046</span>                            <span class='identifier'><a name='46_24' href='Parallelize.swift.html#34_16' title='usrString1'>buffro</a></span>[<span class='identifier'><a name='46_31' href='Parallelize.swift.html#40_16' title='usrString1'>index</a></span>] = <span class='identifier'><a name='46_40' href='Parallelize.swift.html#45_43' title='usrString1'>result</a></span>
<span class=linenum>0047</span>                            <span class='identifier'><a name='47_24' href='Parallelize.swift.html#38_16' title='usrString1'>threadGroup</a></span>.<span class='identifier'>leave</span>()
<span class=linenum>0048</span>                            <span class='identifier'><a name='48_24' href='Parallelize.swift.html#37_16' title='usrString1'>semaphore</a></span>.<span class='identifier'>signal</span>()
<span class=linenum>0049</span>                        })
<span class=linenum>0050</span>                    }
<span class=linenum>0051</span>                }
<span class=linenum>0052</span>    
<span class=linenum>0053</span>                <span class='identifier'><a name='53_12' href='Parallelize.swift.html#38_16' title='usrString1'>threadGroup</a></span>.<span class='identifier'>wait</span>()
<span class=linenum>0054</span>            }
<span class=linenum>0055</span>    
<span class=linenum>0056</span>            <span class='keyword'>return</span> <span class='identifier'><a name='56_15' href='Parallelize.swift.html#24_12' title='usrString1'>output</a></span>
<span class=linenum>0057</span>        }
<span class=linenum>0058</span>    }
<span class=linenum>0059</span>    